___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 125 重构接口GetCharacterLevel函数相关逻辑；处理升级触发逻辑

___________________________________________________________________________________________

## 处理关键点

1. 升级相关触发增益：

   - **获取属性点**

   - **获取技能点**

   - **需要增加**

     - **等级**

     - **属性点**

     - **技能点**

   - **将血量和蓝量增加到上限(也就是满血满蓝)

___________________________________________________________________________________________

# 目录


- [GAS 125 重构接口GetCharacterLevel函数相关逻辑；处理升级触发逻辑](#gas-125-重构接口getcharacterlevel函数相关逻辑处理升级触发逻辑)
  - [处理关键点](#处理关键点)
- [目录](#目录)
    - [Mermaid整体思路梳理](#mermaid整体思路梳理)
    - [希望可以修改旧的 `ICombatInteraction` 中的 `GetPlayerLevel` 函数，也为静态，和下面的函数一样，下面是修改的一系列重构](#希望可以修改旧的-icombatinteraction-中的-getplayerlevel-函数也为静态和下面的函数一样下面是修改的一系列重构)
    - [修改接口函数导致的重构](#修改接口函数导致的重构)
      - [先是函数改名](#先是函数改名)
      - [重构调用处的逻辑](#重构调用处的逻辑)
      - [最后一个报错](#最后一个报错)
  - [当我们在接口中，声明了一个蓝图重写事件时，反射系统会帮我们生成函数的定义，我们只能使用反射生成的定义，如果我们自己写了，就会发生重复定义的报错](#当我们在接口中声明了一个蓝图重写事件时反射系统会帮我们生成函数的定义我们只能使用反射生成的定义如果我们自己写了就会发生重复定义的报错)
    - [下面我们将处理升级](#下面我们将处理升级)
    - [玩家接口中创建升级函数，命名为，`LevelUp`](#玩家接口中创建升级函数命名为levelup)
    - [下一节我们将在AS中处理升级相关的逻辑，也就是这里](#下一节我们将在as中处理升级相关的逻辑也就是这里)
    - [下一节](#下一节)
    - [AS中 `经验值增加` 需要 触发 `升级` 事件](#as中-经验值增加-需要-触发-升级-事件)
      - [在玩家接口中创建 `获取XP` 的函数，玩家基类重写](#在玩家接口中创建-获取xp-的函数玩家基类重写)
    - [我们的新等级怎么获取？需要创建接口函数](#我们的新等级怎么获取需要创建接口函数)
      - [在玩家接口中创建 `根据传入的XP查找并返回对应等级` 的函数，玩家基类重写](#在玩家接口中创建-根据传入的xp查找并返回对应等级-的函数玩家基类重写)
      - [计算获取新的等级](#计算获取新的等级)
    - [判断，当 `新的等级 - 旧的等级 大于 1` ，说明需要调用升级的函数](#判断当-新的等级---旧的等级-大于-1-说明需要调用升级的函数)
    - [我们需要梳理一下，升级都需要处理的逻辑](#我们需要梳理一下升级都需要处理的逻辑)
    - [玩家接口中创建对应的函数](#玩家接口中创建对应的函数)
    - [AS中根据之前梳理的几种逻辑，调用逻辑](#as中根据之前梳理的几种逻辑调用逻辑)
    - [现在升级部分的逻辑处理有些长，实现功能更多的就是通过调用多个接口的方式，后续可能会重构一下。](#现在升级部分的逻辑处理有些长实现功能更多的就是通过调用多个接口的方式后续可能会重构一下)



___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[11. Level Up Interface Function_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=57&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[12. Leveling Up_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=58&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________


### 希望可以修改旧的 `ICombatInteraction` 中的 `GetPlayerLevel` 函数，也为静态，和下面的函数一样，下面是修改的一系列重构

>![](./Image/GAS_125/1.png)![img](./Image/GAS_125/2.png)
>
>![image-20240912175034857](./Image/GAS_125/3.png)

------

### 修改接口函数导致的重构

------

#### 先是函数改名

>![](./Image/GAS_125/4.png)
>
>![image-20240912175212570](./Image/GAS_125/5.png)
>
>![](./Image/GAS_125/6.png)
>![](./Image/GAS_125/7.png)
>![](./Image/GAS_125/8.png)![image-20240912175430754](./Image/GAS_125/9.png)

------

#### 重构调用处的逻辑

>涉及到的文件：
>
>- #### `MMC_MaxHealth`
>- #### `MMC_MaxMana`
>- #### `ExecCalc_Damage`
>- #### `AuraAttributeSet`
>- #### `AuraAbilitySystemLibrary`
>
>![](./Image/GAS_125/10.png)
>
>![img](./Image/GAS_125/11.png)![image-20240912180828451](./Image/GAS_125/12.png)
>
>![](./Image/GAS_125/13.png)![](./Image/GAS_125/14.png)![](./Image/GAS_125/15.png)

------

#### 最后一个报错

> ![img](./Image/GAS_125/16.png)
>
>   - #### **显示：链接器错误，函数已定义**

------

## 当我们在接口中，声明了一个蓝图重写事件时，反射系统会帮我们生成函数的定义，我们只能使用反射生成的定义，如果我们自己写了，就会发生重复定义的报错

>![](./Image/GAS_125/17.png)

------

### 下面我们将处理升级

------

### 玩家接口中创建升级函数，命名为，`LevelUp`

>```cpp
>UFUNCTION(BlueprintNativeEvent)
>void LevelUp();
>```
>
>![img](./Image/GAS_125/18.png)![](./Image/GAS_125/19.png)

------

### 下一节我们将在AS中处理升级相关的逻辑，也就是这里

>![](./Image/GAS_125/20.png)

------

### 下一节


------

### AS中 `经验值增加` 需要 触发 `升级` 事件

> - #### **升级需要获取XP然后计算**

------

#### 在玩家接口中创建 `获取XP` 的函数，玩家基类重写

>```cpp
>UFUNCTION(BlueprintNativeEvent)
>int32 GetXP();
>```
>
>![](./Image/GAS_125/21.png)
>
>![image-20240912182513751](./Image/GAS_125/22.png)
>
>![](./Image/GAS_125/23.png)

------

###  我们的新等级怎么获取？需要创建接口函数

>![image-20240912182944704](./Image/GAS_125/24.png)

------

#### 在玩家接口中创建 `根据传入的XP查找并返回对应等级` 的函数，玩家基类重写

>![](./Image/GAS_125/25.png)![img](./Image/GAS_125/26.png)
>
>![image-20240912183529004](./Image/GAS_125/27.png)

------

#### 计算获取新的等级

>```CPP
>if (Props.SourceCharacter->Implements<UPlayerInteraction>())
>{
>    const int32 InXP = IPlayerInteraction::Execute_GetXP(Props.SourceCharacter);
>    const int32 InLevel = IPlayerInteraction::Execute_GetLevel(Props.SourceCharacter);
>    const int32 NewLevel = IPlayerInteraction::Execute_FindLevelForXP(Props.SourceCharacter, InXP + LocalInComingXP);
>    
>    IPlayerInteraction::Execute_AddToXP(Props.SourceCharacter,LocalInComingXP);
>}
>```
>
>![](./Image/GAS_125/28.png)

------

### 判断，当 `新的等级 - 旧的等级 大于 1` ，说明需要调用升级的函数

>![](./Image/GAS_125/29.png)

------

### 我们需要梳理一下，升级都需要处理的逻辑

>   ![img](./Image/GAS_125/30.png)
>
>   - #### **获取属性点**
>
>   - #### **获取技能点**
>
>   - #### **需要增加**
>
>     - **等级**
>
>     - **属性点**
>
>     - **技能点**
>
>   - #### **将血量和蓝量增加到上限(也就是满血满蓝)**
>
>   ------
>
>   - 获取属性点
>
>     ```CPP
>     GetAttributePointsReward()
>     ```
>
>   - 获取技能点
>
>     ```CPP
>     GetSpellPointsReward()
>     ```
>
>   - 需要增加等级
>
>     ```CPP
>     AddToPlayerLevel()
>     ```
>
>   - 需要增加属性点
>
>     ```CPP
>     AddToAttributePoints()
>     ```
>
>   - 需要增加技能点
>
>     ```CPP
>     AddToSpellPoints()
>     ```
>
>   - 将血量和蓝量增加到上限(也就是满血满蓝)
>
>     ```CPP
>     FillUpHealthAndMana()
>     ```
>
>   
>
>
>   ![img](./Image/GAS_125/31.png)

------

### 玩家接口中创建对应的函数

>![](./Image/GAS_125/32.png)![image-20240912190121865](./Image/GAS_125/33.png)![image-20240912190142004](./Image/GAS_125/34.png)

------

### AS中根据之前梳理的几种逻辑，调用逻辑

>![img](./Image/GAS_125/30.png)
>
>![](./Image/GAS_125/36.png)
>
>**66节**![img](./Image/GAS_125/37.png)

------

### 现在升级部分的逻辑处理有些长，实现功能更多的就是通过调用多个接口的方式，后续可能会重构一下。


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
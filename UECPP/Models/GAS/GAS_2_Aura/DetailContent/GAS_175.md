___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 175 客户端不能 `EndAbility` ！火球Actor除了开启复制，还需要开启复制运动！添加眩晕特效；保证玩家也能被眩晕和DS客户端修改逻辑

___________________________________________________________________________________________

## 处理关键点

1. 客户端无法结束技能！需要服务器结束技能

2. 之前我们给 火球Actor设置了开启复制，还需要设置 `复制运动` `ReplicateMovement`
    - 不能在构造中设置，因为这是一个虚函数
    
      ```cpp
      SetReplicateMovement(true);
      ```

___________________________________________________________________________________________

# 目录


- [GAS 175 客户端不能 `EndAbility` ！火球Actor除了开启复制，还需要开启复制运动！添加眩晕特效；保证玩家也能被眩晕和DS客户端修改逻辑](#gas-175-客户端不能-endability-火球actor除了开启复制还需要开启复制运动添加眩晕特效保证玩家也能被眩晕和ds客户端修改逻辑)
  - [处理关键点](#处理关键点)
- [目录](#目录)
    - [Mermaid整体思路梳理](#mermaid整体思路梳理)
    - [还有一个bug：DS模式下，当客户端按下闪电技能后立即松开，并没有停止技能释放，（虽然看着像在释放技能但是并没有扣除魔法，说明没有移除Cue）](#还有一个bugds模式下当客户端按下闪电技能后立即松开并没有停止技能释放虽然看着像在释放技能但是并没有扣除魔法说明没有移除cue)
    - [运行测试，这次可以结束技能了](#运行测试这次可以结束技能了)
    - [还需要处理一些逻辑](#还需要处理一些逻辑)
      - [当准备结束技能时，要应用GE时需要检查（只有服务器才可以应用GE）](#当准备结束技能时要应用ge时需要检查只有服务器才可以应用ge)
    - [在使用火球攻击敌人时，空指针，因为ASC空指针](#在使用火球攻击敌人时空指针因为asc空指针)
      - [只有服务器才能处理重叠](#只有服务器才能处理重叠)
    - [我们之前忘记使用引用委托了](#我们之前忘记使用引用委托了)
    - [之前我们给 火球Actor设置了开启复制，还需要设置 `复制运动` `ReplicateMovement`](#之前我们给-火球actor设置了开启复制还需要设置-复制运动-replicatemovement)
      - [在蓝图中配置 `复制运动` `ReplicateMovement`](#在蓝图中配置-复制运动-replicatemovement)
    - [运行测试gif：现在应该没什么问题了](#运行测试gif现在应该没什么问题了)
    - [接下来我们需要为debuff添加特效](#接下来我们需要为debuff添加特效)
      - [我们使用之前创建的NS组件，添加眩晕 `Debuff` 特效NS组件](#我们使用之前创建的ns组件添加眩晕-debuff-特效ns组件)
      - [之前在敌人死亡时，取消激活，也需要停用眩晕的Debuff](#之前在敌人死亡时取消激活也需要停用眩晕的debuff)
    - [蓝图中配置，并调整位置](#蓝图中配置并调整位置)
    - [DS运行测试，客户端眩晕时并没有激活NS，服务器可以正常激活](#ds运行测试客户端眩晕时并没有激活ns服务器可以正常激活)
      - [因为我们还没有在属性复制通知的回调函数写逻辑](#因为我们还没有在属性复制通知的回调函数写逻辑)
    - [运行测试gif：客户端也可以显示了](#运行测试gif客户端也可以显示了)
    - [但是因为之前只有敌人可以烧伤Debuff，没有发现，现在玩家也需要烧伤效果，需要参考击晕使用属性复制回调函数，在客户端执行 激活/关闭 烧伤的NS](#但是因为之前只有敌人可以烧伤debuff没有发现现在玩家也需要烧伤效果需要参考击晕使用属性复制回调函数在客户端执行-激活关闭-烧伤的ns)
    - [以下是自己搞得 燃烧效果的同步，有点疑问](#以下是自己搞得-燃烧效果的同步有点疑问)



___________________________________________________________________________________________

<details>
<summary>视频链接</summary>
[21. Stun Niagara System_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP?spm_id_from=333.788.player.switch&vd_source=9e1e64122d802b4f7ab37bd325a89e6c&p=134)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 还有一个bug：DS模式下，当客户端按下闪电技能后立即松开，并没有停止技能释放，（虽然看着像在释放技能但是并没有扣除魔法，说明没有移除Cue）
>![img](./Image/GAS_175/25165450_8db2b6f5-29ee-4dd1-dc28-bb1a1538c773.png)

- 因为客户端无法EndAbility，只有服务器可以，所以需要限制客户端逻辑
>![image-20241020185848779](./Image/GAS_175/image-20241020185848779.png)

- 因为取消技能时，的delay
>![BPGraphScreenshot_2024Y-10M-20D-23h-50m-06s-539_00](./Image/GAS_175/BPGraphScreenshot_2024Y-10M-20D-23h-50m-06s-539_00.png)


------

### 运行测试，这次可以结束技能了


------

### 还需要处理一些逻辑


------

#### 当准备结束技能时，要应用GE时需要检查（只有服务器才可以应用GE）
>### 只有服务器才可以应用GE
>
>![BPGraphScreenshot_2024Y-10M-20D-23h-55m-32s-947_00](./Image/GAS_175/BPGraphScreenshot_2024Y-10M-20D-23h-55m-32s-947_00.png)


------

### 在使用火球攻击敌人时，空指针，因为ASC空指针

  - 应该是在客户端，所以需要检查

>![img](./Image/GAS_175/25165450_f8c791c8-4b69-4850-f332-1004882c525c.png)


------

#### 只有服务器才能处理重叠
>## 我在这里处理过了
>
>![image-20241020235820353](./Image/GAS_175/image-20241020235820353.png)


------

### 我们之前忘记使用引用委托了
>![img](./Image/GAS_175/25165450_6a425815-6f49-40a3-8f96-066003f17fc0.png)


------

### 之前我们给 火球Actor设置了开启复制，还需要设置 `复制运动` `ReplicateMovement`

  - 不能在构造中设置，因为这是一个虚函数

  - 也可以在蓝图中配置

>![img](./Image/GAS_175/25165450_5a291dc6-f561-4a0e-ccf1-6ef7e781309f.png)

>![image-20241021003437584](./Image/GAS_175/image-20241021003437584.png)


------

#### 在蓝图中配置 `复制运动` `ReplicateMovement`
>![image-20241021003646096](./Image/GAS_175/image-20241021003646096.png)


------

### 运行测试gif：现在应该没什么问题了
>![175-1](./Image/GAS_175/175-1.gif)

- 攻击/玩家眩晕


------

### 接下来我们需要为debuff添加特效


------

#### 我们使用之前创建的NS组件，添加眩晕 `Debuff` 特效NS组件
>`StunDebuffComponent`
>
>```cpp
>protected:
>	//眩晕特效组件
>	UPROPERTY(VisibleAnywhere)
>	TObjectPtr<UDebuffNiagaraComponent> StunDebuffComponent;
>```
>
>![image-20241021004328928](./Image/GAS_175/image-20241021004328928.png)
>![image-20241021004539166](./Image/GAS_175/image-20241021004539166.png)
>
>```cpp
>StunDebuffComponent = CreateDefaultSubobject<UDebuffNiagaraComponent>(TEXT("StunDebuffComponent"));
>StunDebuffComponent->SetupAttachment(RootComponent);
>StunDebuffComponent->DebuffTag = FAuraGameplayTags::Get().Debuff_Stun;
>```


------

#### 之前在敌人死亡时，取消激活，也需要停用眩晕的Debuff
>![image-20241021004727920](./Image/GAS_175/image-20241021004727920.png)


------

### 蓝图中配置，并调整位置
>![image-20241021005103991](./Image/GAS_175/image-20241021005103991.png)
>![img](./Image/GAS_175/25165450_4a97e9ef-f8dd-48d5-838f-432e3fac629e.png)
>
>Aura也需要配置NS
>
>![image-20241021005234160](./Image/GAS_175/image-20241021005234160.png)


------

### DS运行测试，客户端眩晕时并没有激活NS，服务器可以正常激活
>![175-2](./Image/GAS_175/175-2.gif)


------

#### 因为我们还没有在属性复制通知的回调函数写逻辑
>所以客户端并不知道修改
>
>![image-20241021005729825](./Image/GAS_175/image-20241021005729825.png)

- 之前只处理了添加阻挡的Tag，还需要根据属性赋值的bool激活和关闭NS

------

### 运行测试gif：客户端也可以显示了
>![175-3](./Image/GAS_175/175-3.gif)


------

### 但是因为之前只有敌人可以烧伤Debuff，没有发现，现在玩家也需要烧伤效果，需要参考击晕使用属性复制回调函数，在客户端执行 激活/关闭 烧伤的NS
>![image-20241021010226219](./Image/GAS_175/image-20241021010226219.png)
>![image-20241021010252083](./Image/GAS_175/image-20241021010252083.png)
>
>## 子类想要单独修改逻辑，需要将回调改为虚函数
>
>![image-20241021010414912](./Image/GAS_175/image-20241021010414912.png)
>
>![image-20241021010534927](./Image/GAS_175/image-20241021010534927.png)
>
>![image-20241021010715524](./Image/GAS_175/image-20241021010715524.png)
>
>```cpp
>void AAuraCharacter::OnRep_Burned()
>{
>    if (bIsBurned)
>    {
>       BurnDebuffComponent->Activate();
>    }
>    else
>    {
>       BurnDebuffComponent->Deactivate();
>    }
>}
>```


------

### 以下是自己搞得 燃烧效果的同步，有点疑问

<details>
<summary>过程截图</summary>

>创建属性同步变量
>
>![image-20241021014043913](./Image/GAS_175/image-20241021014043913.png)
>
>监听Tag变化
>
>![image-20241021014126701](./Image/GAS_175/image-20241021014126701.png)
>
>![image-20241021014236074](./Image/GAS_175/image-20241021014236074.png)
>
>玩家基类中重写属性复制变化回调
>
>![image-20241021014323932](./Image/GAS_175/image-20241021014323932.png)
>
>![image-20241021014350632](./Image/GAS_175/image-20241021014350632.png)
>
>并在初始化完成后绑定
>
>![image-20241021014427844](./Image/GAS_175/image-20241021014427844.png)
>
>## 这样属性变化时，就会触发回调 `BurnTagChanged` 然后服务器1修改变量2激活组件；客户端在属性复制回调中激活组件
>
>因为我发现服务器上的客户端角色（也就是非主控角色）好像没有这个 `DebuffNiagaraComponent` 自建的NS组件，需要有时间的时候查一查
>
>最后是把敌人攻击类型改为火焰测试
>
>![image-20241021014806081](./Image/GAS_175/image-20241021014806081.png)
>
># 区别是：
>
>- ### **服务器：走组件的监听Tag回调逻辑，同步客户端走的属性复制的回调**
>
>- ### **客户端：没有走组件的逻辑，走的是纯本体监听Tag回调->属性复制回调的逻辑**
>
># gif：
>
>![175-4](./Image/GAS_175/175-4.gif)

------

</details>


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
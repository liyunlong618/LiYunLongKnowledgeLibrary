<details>
<summary>过程截图</summary>

>

------

</details>




+ `头文件`中：
```cpp
这里是头文件代码这里是头文件代码这里是头文件代码这里是头文件代码这里是头文件代码这里是头文件代码
```

+ `源文件`中：
```cpp
这里是源文件代码这里是源文件代码这里是源文件代码这里是源文件代码这里是源文件代码这里是源文件代码
```

[Mermaid格式参考](https://github.com/liyunlong618/LiYunLongKnowledgeLibrary/blob/main/Mermaid%E6%A0%BC%E5%BC%8F%E5%8F%82%E8%80%83.md)

[预览](https://github.com/liyunlong618/LiYunLongKnowledgeLibrary/tree/main/UECPP/Models/GAS/GAS_2_Aura)



___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 117 使用异步任务 `BlueprintAsyncActionBase` 制作蓝图节点

___________________________________________________________________________________________

## 处理关键点

1. 111111111111111111111111111111

2. 222222222222222222222222222

3. 33333333333333333333333333

4. 4444444444444444444444444444

5. 555555555555555555555555555555

6. 666666666666666666666666666

7. 77777777777777777777777777777777

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[11. Cooldown Async Task_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP?p=43&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[12. Cooldown Tags in Ability Info_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=44&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[13. Showing Cooldown Time in the HUD_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=45&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 现在希望在技能开始时，`触发回调` 的同时还要传递一个 `冷却时间的float值` ；技能结束时，仅 `触发回调`

  - 之需要传递冷却时间的float给UI就行，然后UI内部维护和处理变量，并不用每Tick都和异步节点同步数据

  - UI中可以使用计时器来制作

  - 我们之前也制作过异步任务，在代码中，输出引脚意味着广播之后的回调![img](https://api2.mubu.com/v3/document_image/25165450_65cb4a65-1377-4692-cafe-b21403c865d1.png)

  - 比如这个就是个异步任务![img](https://api2.mubu.com/v3/document_image/25165450_84e6e4b5-e1f8-472b-b5e9-b073df9c47d2.png)


------

### 使用异步任务的步骤

  - 1.创建 `BlueprintAsyncActionBase` C++类

  - 2.需要创建一个静态函数返回自身的指针

    - 填写需要的形参

    - 第一步：启动。需要使用 `NewObject<类>();` 构建一个新的局部变量

    - 第二步：当逻辑失败时，需要调用下面的销毁自身的函数

    - 第三步：当执行完逻辑，记得返回第一步创建的局部变量，也就是自身指针！

  - 4.创建一个结束时，销毁异步任务自身的函数

    - 结束时，需要调用的API

      - `SetReadyToDestroy();`
        - 源码备注为 “当操作完全完成时调用，这使得该动作可以自由删除，我们将在游戏实例中取消注册它”

      - `MarkAsGarbage();`
        - 在GC中标记为垃圾，可以回收

  - 3.创建需要的蓝图动态多播
    - 有几个输出引脚就声明几个动态多播


------

### 创建 `BlueprintAsyncActionBase` C++类
>![img](https://api2.mubu.com/v3/document_image/25165450_2a95c59c-e542-4fb2-e2ac-9d1638bd792f.png)


------

### 创建蓝图动态多播，需要广播 `冷却时间` 的 `float`
>![img](https://api2.mubu.com/v3/document_image/25165450_5804e226-6fc6-4658-9534-1117e2bfe562.png)


------

#### 声明两个动态多播实例

  - `CooldownStart`

  - `CooldownEnd`

  - ![img](https://api2.mubu.com/v3/document_image/25165450_8f38bcdc-b99d-4c04-8605-a7800aebc712.png)

  - 现在一旦我们广播，输出引脚将会被执行


------

#### 创建一个静态成员函数，返回自身指针，命名为，`WaitForCooldownChange`

  - 需要两个参数，用来监听该Tag的变化

    - ASC组件

    - 技能冷却触发的 `GameplayTag`

  - 

  - 需要使用反射宏 `UFUNCTION(BlueprintCallable, meta =(BlueprintInternalUseOnly = "true"))`

  - ![img](https://api2.mubu.com/v3/document_image/25165450_6bc88de0-b16b-4ae7-d0fa-a7bf149af8a9.png)![img](https://api2.mubu.com/v3/document_image/25165450_da0a6175-c457-480f-aa23-47287b41a4e0.png)


------

#### 创建一个结束时，销毁异步任务自身的函数
>![img](https://api2.mubu.com/v3/document_image/25165450_df3e3d68-f5f5-4883-a34a-91c1b0a3295d.png)![img](https://api2.mubu.com/v3/document_image/25165450_ba0abd92-69af-42fb-d089-44a67ee60a7d.png)


------

#### 这个异步任务节点本身也是类，也可以存储一些变量

  - 创建两个Protected变量，内部保存 `ASC组件` 和 `GameplayTag`

  - ![img](https://api2.mubu.com/v3/document_image/25165450_0b3d5d47-1dff-4137-b0ff-4da8546d0443.png)


------

#### 在返回自身的静态成员函数 `WaitForCooldownChange` 中，写主要逻辑


------

##### 第一步：启动。需要使用 `NewObject<类>();` 构建一个新的局部变量
>![img](https://api2.mubu.com/v3/document_image/25165450_68328982-86c3-4a58-a905-3ace4fe9dc04.png)


------

##### 使用实参为成员变量赋值
>![img](https://api2.mubu.com/v3/document_image/25165450_5992e544-3b0f-4095-900b-71a1c82fcf2e.png)


------

##### 如果 `关键变量` 为空，则调用 创建的销毁函数 `EndTask` 销毁自身并返回 `nullptr`
>![img](https://api2.mubu.com/v3/document_image/25165450_52639357-d2a2-49bf-d0cc-bd60ea339d5e.png)


------

##### 监听 `GameplayTag` 变化

  - 使用API：`AbilitySystemComponent->RegisterGameplayTagEvent`

  - 创建回调函数，命名为，`CooldownTagChanged`

  - 需要注意的是，在绑定回调时，不可以在静态函数内使用 `this` ！！！

  - ![img](https://api2.mubu.com/v3/document_image/25165450_22bd12a0-456a-40c4-da82-114ecc780a9d.png)

  - ![img](https://api2.mubu.com/v3/document_image/25165450_0998a9e2-743e-469e-cfde-f4407b2d5fce.png)

  - ![img](https://api2.mubu.com/v3/document_image/25165450_b99c5cdb-06a4-4680-d135-787a90234231.png)


------

##### 绑定监听回调后，返回自身
>![img](https://api2.mubu.com/v3/document_image/25165450_d1cce7af-53ce-447a-9632-36f9f2956856.png)


------

#### 静态函数中写完绑定回调之后，根据回调的 `新Tag计数` 不同触发不同的蓝图动态广播


------

## 接下来，有一个注意点，虽然我们监听Tag变化的回调可以帮助我们知道何时开始技能冷却，但是，可能并没有那么准确，可能会有滞后性，但是GE的添加不会有滞后，所以为了监听的准确，在技能开始时需要监听GE的添加，结束时，监听Tag新计数即可

  - 因为 `OnActiveGameplayEffectAddedDelegateToSelf` 直接监听到 `Gameplay Effect (GE)` 的 `添加事件` ，比通过标签变化回调的触发更及时和直接。

  - 为什么需要绑定 `OnActiveGameplayEffectAddedDelegateToSelf`

    - GE 添加的及时性:
      - 通过 OnActiveGameplayEffectAddedDelegateToSelf，你可以立即知道冷却 GE 何时被应用到 AbilitySystemComponent 上。这是最直接的方式来捕捉冷却开始的事件。

    - 冷却标签的延迟:

      - 虽然冷却 GE 会在应用时添加冷却标签，但标签的变化事件有时会稍有延迟，或者在标签的变化逻辑上受到其他条件的影响。

      - 通过监听 GE 的添加，可以确保回调在冷却开始时立即响应，而不仅仅依赖于标签的增加。

  - 查看 `ASC源码` ，源码备注为：`每当添加基于持续时间的 GE 时都会调用客户端和服务器`![img](https://api2.mubu.com/v3/document_image/25165450_64bb8981-6d74-4540-f595-239e72563cad.png)


------

#### 所以需要在静态函数中也绑定 `添加GE的回调`  `OnActiveGameplayEffectAddedDelegateToSelf`


------

##### 创建监听GE的回调函数

  - 命名为 `OnActiveEffectAdded`

  - 需要三个参数

  - ![img](https://api2.mubu.com/v3/document_image/25165450_2ec24280-6246-4872-e257-6f790a9d4fe3.png)![img](https://api2.mubu.com/v3/document_image/25165450_d4412676-7ee7-4823-d663-750b9ae93435.png)![img](https://api2.mubu.com/v3/document_image/25165450_de97709c-233f-417e-a28c-248940e3d01a.png)


------

#### 现在需要在回调函数中拿 `技能冷却的Tag`

  - 使用API：拿到GE身上的Tag

    - `SpecApplied/*FGameplayEffectSpec*/.GetAllAssetTags(AssetTags/*FGameplayTagContainer*/);`

    - SpecApplied/*FGameplayEffectSpec*/.GetAllGrantedTags(GrantedTags/*另一个FGameplayTagContainer*/);


------

##### 检查是否包含冷却标签

  - 使用API：`HasTagExact` ，检查 `FGameplayTagContainer` 中是否含有指定标签

>![img](https://api2.mubu.com/v3/document_image/25165450_e2a5e218-995b-45d5-835a-e1843011c059.png)


------

#### 现在需要拿GE中的冷却时间

  - 使用API：`ASC->GetActiveEffectsTimeRemaining`


------

##### 要使用需要传入一个 `FGameplayEffectQuery` 类型变量，创建一个局部变量，需要调用静态函数赋值

  - 使用API：`FGameplayEffectQuery::MakeQuery_MatchAnyOwningTags` 获取与此特定冷却标签匹配的任何效果

    - 这个函数会返回一个 `TArray<float>` 包含所有含有该Tag的冷却时间

      - 按道理说第一个就是![img](https://api2.mubu.com/v3/document_image/25165450_cfeb98d0-6840-4869-e2c9-7785d536278b.png)

      - 但如果觉得不保准，可以遍历一下，找到最大的float，这个float就是![img](https://api2.mubu.com/v3/document_image/25165450_630b2db5-7c3a-4fb7-ecc5-94d2fec8e423.png)

      - ![img](https://api2.mubu.com/v3/document_image/25165450_cead4a3e-e89f-4d1e-99eb-6de32d62cf50.png)

    - 需要传入一个 `FGameplayTagContainer`，使用API：`单个Tag.GetSingleTagContainer();`

  - ![img](https://api2.mubu.com/v3/document_image/25165450_3c7d9413-da33-41e8-be21-75eca4ee7a1c.png)


------

##### 最后将找到的 float 值进行广播
>![img](https://api2.mubu.com/v3/document_image/25165450_538a46e2-800c-4f74-b08d-afde5abbff4e.png)


------

#### 当 `EndTask` 被触发时，需要处理的逻辑

  - 1.若有绑定委托，需要清空并从其委托列表中删除该回调


------

##### 1.若有绑定委托，需要清空并从其委托列表中删除该回调
>![img](https://api2.mubu.com/v3/document_image/25165450_ef6521de-26cb-4a8e-bd61-a73ebe2bf07c.png)


------

##### 2.结束时，需要调用的API

  - `SetReadyToDestroy();`
    - 源码备注为 “当操作完全完成时调用，这使得该动作可以自由删除，我们将在游戏实例中取消注册它”

  - `MarkAsGarbage();`
    - 在GC中标记为垃圾，可以回收


------

### 此时运行即可在蓝图中找到该异步任务节点
>![img](https://api2.mubu.com/v3/document_image/25165450_84511124-813f-4101-aff6-4a5f1a989f1e.png)![img](https://api2.mubu.com/v3/document_image/25165450_e49fba13-3716-4f9b-ca9b-d765a952d4d6.png)


------

### 现在希望添加一个返回值，就是对异步任务类这个任务的实例的引用，这样就可以处理手动 `EndTask` ，所以需要增加输出引脚返回自身

  - ![img](https://api2.mubu.com/v3/document_image/25165450_84511124-813f-4101-aff6-4a5f1a989f1e.png)

  - 需要在类的宏UClass中添加宏![img](https://api2.mubu.com/v3/document_image/25165450_a9c9eda0-3be8-4dd7-faca-8fc673840124.png)

  - ![img](https://api2.mubu.com/v3/document_image/25165450_8cf0c344-ea58-42f8-d892-dfee27bf9ee1.png)


------

### 如果绑定该异步任务前，变量有效需要执行 `EndTask` 清空数据
>![img](https://api2.mubu.com/v3/document_image/25165450_285806d8-4479-4b10-cc61-ca8b437f9450.png)


------

### 我们之前的结构体中，还需要传递一个 `CooldownTag` 
>![img](https://api2.mubu.com/v3/document_image/25165450_285dc1fb-933d-489f-d011-e0af3aa75e4e.png)


------

### 我们显示用硬编码，暂时手动给一个
>![img](https://api2.mubu.com/v3/document_image/25165450_72dc8403-ab47-4402-e56e-7b73d0318b7b.png)![img](https://api2.mubu.com/v3/document_image/25165450_e3ae43a6-4c1a-43dc-e6e3-4cedfdca9507.png)


------

#### 先把CD调长一些，再测试
>![img](https://api2.mubu.com/v3/document_image/25165450_0b266fde-b371-4e9a-ac67-f6c87fc4c063.png)


------

### 此时测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_7bf14499-70f0-434f-eb44-9433c1f66dd1.png)


------

### 下一节

- 


------

### 所以现在所有的技能UI都能触发冷却时间开始和结束的回调，需要在结构体上传递数据设置UI自身，并判断冷却Tag匹配


------

#### 添加一个冷却标签，蓝图中配置
>![img](https://api2.mubu.com/v3/document_image/25165450_232d16c6-a3fb-4b1d-82e5-e52f6d292075.png)![img](https://api2.mubu.com/v3/document_image/25165450_5fc1eed0-7c57-4ebd-ae0c-9ca75daa95ba.png)


------

#### 之前已经判断过标签是否匹配了，现在需要传值
>![img](https://api2.mubu.com/v3/document_image/25165450_9a0507bc-38e1-4eb2-97da-c9da53947cfb.png)


------

### 现在因为有依赖关系，所以需要保证在设置好 `冷却标签` 后才执行异步任务节点
>![img](https://api2.mubu.com/v3/document_image/25165450_3cf9c212-6057-4404-cafd-95f77ff90e9e.png)![img](https://api2.mubu.com/v3/document_image/25165450_28a00c55-6106-45d7-a96c-d9062d3995cb.png)


------

### 此时打印测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_a29e49db-57d9-4319-f677-7ff8c661151e.png)


------

### 下一节

- 


------

### 接下来我们需要处理，在开始技能CD的时候，内部处理更新显示UI，剩余冷却时间的Text


------

#### 测试一下gif
>![img](https://api2.mubu.com/v3/document_image/25165450_eb44ae1b-d8a2-46b7-f449-80a47e0b7402.png)![img](https://api2.mubu.com/v3/document_image/25165450_d11b8d69-af3c-45c4-cf78-f9e398fcc222.png)![img](https://api2.mubu.com/v3/document_image/25165450_365cfbda-bf04-4c66-986c-bcc3f27a29ba.png)


------

### 接下来使用计时器处理内部逻辑

  - ![img](https://api2.mubu.com/v3/document_image/25165450_4316bc47-9a30-430a-d6c5-b3b609cc73d2.png)![img](https://api2.mubu.com/v3/document_image/25165450_77c434ea-870e-45be-a815-829221896627.png)![img](https://api2.mubu.com/v3/document_image/25165450_3b7f3f78-04a9-4b67-8c96-b39ab902fedd.png)![img](https://api2.mubu.com/v3/document_image/25165450_040bf7dc-603f-46da-90af-28e451f128d6.png)![img](https://api2.mubu.com/v3/document_image/25165450_d3402a64-a628-430a-9c9e-646c5f28df29.png)![img](https://api2.mubu.com/v3/document_image/25165450_e63622a2-bb88-4c59-f17b-a677a8c861ec.png)![img](https://api2.mubu.com/v3/document_image/25165450_f51a4d31-cc1e-410c-c60e-715b9f612be5.png)![img](https://api2.mubu.com/v3/document_image/25165450_f85ea656-61ba-4bc1-b782-4eaa0ca263cb.png)![img](https://api2.mubu.com/v3/document_image/25165450_c40ce970-85c3-4ef8-ac3a-780ead1f6377.png)![img](https://api2.mubu.com/v3/document_image/25165450_d046b185-331e-45a6-9bbb-3aa54d3c7a5c.png)![img](https://api2.mubu.com/v3/document_image/25165450_82304918-b749-4cd5-8a97-5ac81ce6c543.png)![img](https://api2.mubu.com/v3/document_image/25165450_0032b9ae-e834-41db-d2be-5f38656042ec.png)


------

### 此时效果gif
>![img](https://api2.mubu.com/v3/document_image/25165450_a5b0b15d-01c0-4c44-fa74-80de50bdc18a.png)
___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
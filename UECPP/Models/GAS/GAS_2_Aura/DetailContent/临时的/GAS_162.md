___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 162 创建闪电技能C++类；创建并使用释放技能蒙太奇；处理释放持续引导类技能时，禁用角色移动

___________________________________________________________________________________________

## 处理关键点

1. 取消技能API： `CancelAbility();`
2. 通过角色移动组件 `CharacterMovementComponent` ： `启用` / `禁用` 移动的方式
3. 关于使用蒙太奇，有两种框架设计上处理的方式
   - 项目中可能使用的：
     - 创建接口函数：可以通过接口来实现这种功能。接口可以用于定义一个函数，专门用来获取触电蒙太奇。所有角色类都可以实现这个接口，确保每个角色都有触电蒙太奇的动画设置。
   - 个人简化版本：
     - 简化的实现方式：如果不想为每个角色类都创建接口，可以在**电击游戏能力（Electrocute Ability）**中直接设置一个变量，用来存储触电蒙太奇。

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[6. Aura Beam Spell_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=119&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[7. Electrocute Montage_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP?p=120&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________




------

### 需要创建一个闪电技能的C++类，因为会涉及到一些计算，调用蓝图可调用函数的性能更高


------

### 创建闪电技能的C++类继承自 `AuraDamageGameplayAbility`

  - 命名为：`AuraBeamSpell`

>![img](https://api2.mubu.com/v3/document_image/25165450_9df8c36c-1c2c-4522-e9b7-b07e0f5f5961.png)


------

### 修改蓝图父类
>![img](https://api2.mubu.com/v3/document_image/25165450_112a2584-48f3-48a7-ecf5-63a9def27972.png)


------

### 当我们点击时，需要获取目标地点的数据。可以使用之前的异步节点 `TargetDataUnderMouse`
>![img](https://api2.mubu.com/v3/document_image/25165450_c44cfae6-0de3-4577-bf3f-3a17f6025b91.png)


------

### 在C++中创建蓝图调用函数，传参到C++，需要几个参数：

  - PC(用于隐藏/显示鼠标)

    - 函数命名为：`StoreOwnerPlayerController`

    - 变量命名为：`OwnerPlayerController`

  - 可以使用FHitResult设置 FVector 和 AActor*

    - 鼠标点击的敌人指针
      - 变量命名为：`MouseHitActor`

    - 鼠标点击地点
      - 变量命名为：`MouseHitLocation`

    - 函数命名为：`StoreMouseDataInfo`

>![img](https://api2.mubu.com/v3/document_image/25165450_50c6829f-ab88-4c8c-a108-6da035ededab.png)


------

#### `StoreMouseDataInfo` 函数中，如果HitResult击中了目标，设置两个变量，如果没击中，需要取消技能，使用API：`CancelAbility();`

  - 需要传几个参数

>![img](https://api2.mubu.com/v3/document_image/25165450_2a4ad51d-55c3-4a1e-b8f8-5f065d129c4f.png)


------

#### `StoreOwnerPlayerController` 函数中，需要设置PC可以使用 `CurrentActorInfo` 中的PC的弱指针设置
>![img](https://api2.mubu.com/v3/document_image/25165450_26a66d49-4633-44ef-90ac-fa8257138236.png)


------

#### 蓝图中调用
>![img](https://api2.mubu.com/v3/document_image/25165450_05ace228-e847-405d-bcdb-62ecee195988.png)


------

##### 加上备注：这里是获取数据部分
>![img](https://api2.mubu.com/v3/document_image/25165450_53da26d0-4c33-4a78-c1c4-0de0d12c0c53.png)


------

### 执行完后，就获取到了PC，此时可以处理显示/隐藏鼠标的逻辑

  - 当释放按键时，重新显示鼠标，并结束技能

>![img](https://api2.mubu.com/v3/document_image/25165450_d0e125aa-42a9-4cff-e215-b08ed8eae2ae.png)


------

### 测试一下，应该正常


------

### 关于使用蒙太奇，有两种框架设计上处理的方式

  - 项目中可能使用的：

    - 创建接口函数：可以通过接口来实现这种功能。接口可以用于定义一个函数，专门用来获取触电蒙太奇。所有角色类都可以实现这个接口，确保每个角色都有触电蒙太奇的动画设置。
      - 例如，如果你有一个元素师接口（Elementalist Interface），你可以为它创建一个函数来返回触电时播放的蒙太奇。

    - 大型项目的专门化：在大型项目中，可能需要对不同角色进行专门化设计，即每个角色类可以有自己的接口，这样每个类都有适合自己的动画蒙太奇。这个设计有助于项目结构的清晰性和扩展性。

  - 个人简化版本：
    - 简化的实现方式：如果不想为每个角色类都创建接口，可以在**电击游戏能力（Electrocute Ability）**中直接设置一个变量，用来存储触电蒙太奇。
      - 通过这种方式，如果你为不同的敌人派生了不同的触电游戏能力类（Electrocute Ability），你可以在派生类中为每个敌人设置不同的蒙太奇动画。这种方法更灵活，可以针对不同敌人定制化触电动画。


------

#### 这里使用个人简化版本。创建蒙太奇变量，用于播放蒙太奇

  - 变量命名为：`Montage_Electrocute`

>![img](https://api2.mubu.com/v3/document_image/25165450_119fdf71-c83b-4e6b-9797-e3bfc604187f.png)


------

### 下一节，我们将制作播放蒙太奇


------

### 需要先制作蒙太奇动画，并配置，然后配置变量


------

#### 创建蒙太奇，命名为：`AM_Cast_Electrocute` 


------

##### 使用的动画素材
>![img](https://api2.mubu.com/v3/document_image/25165450_a759a82e-fcc9-4344-d047-096f620751f1.png)


------

##### 要使用 `MotionWarping` 所以记得把 `攻击开始` 的动画设置为开启 `根运动`
>![img](https://api2.mubu.com/v3/document_image/25165450_e2b2448c-ac59-4f0d-e7e9-3f454d343e68.png)


------

##### 配置 `MotionWarping` 和EventTag，但是没有闪电技能的Tag，需要添加一个 `EventTag` 
>![img](https://api2.mubu.com/v3/document_image/25165450_1af14cce-059e-4d14-9677-87494de43159.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_f05a0eb2-8074-4cae-d429-390f17435230.png)


------

###### 添加 闪电技能的 `EventTag` 并配置

- 直接在项目设置里添加了
>![img](https://api2.mubu.com/v3/document_image/25165450_69f9bb4a-ce1f-40b6-8059-7e2d62923485.png)

- 配置 `EventTag` 
>![img](https://api2.mubu.com/v3/document_image/25165450_fc8b7b40-1bb2-4403-cc60-e08cf5388f59.png)


------

#### 蓝图中配置蒙太奇
>![img](https://api2.mubu.com/v3/document_image/25165450_d1ce03b2-104a-40e3-9857-96fe872f47f4.png)


------

#### 现在还需要更新 `MotionWarping` 的 `WarpingTarget`

- 我们之前在火球技能里面是这么实现的
>![img](https://api2.mubu.com/v3/document_image/25165450_6eca2e2a-42d0-4e78-c337-418cc01707ad.png)

- 沿用一下
>![img](https://api2.mubu.com/v3/document_image/25165450_87bc759f-e9bd-4a6a-929c-8c6958b2a0d5.png)


------

##### 但是，我们已经在代码里更新了接口函数，蓝图中，不用判断目标是否实现接口，修改这里的使用方式
>![img](https://api2.mubu.com/v3/document_image/25165450_14df0558-1918-4248-8469-e913cb5a13a0.png)


------

#### 然后播放蒙太奇
>![img](https://api2.mubu.com/v3/document_image/25165450_f1935e5c-915d-4fe6-a89d-2b5502b2307c.png)


------

### 运行测试，但是人物鬼畜


------

#### 看下原因，是因为动画太短了，被混入混出的时间覆盖，设置一下，缩短混入混出时间尝试
>![img](https://api2.mubu.com/v3/document_image/25165450_115653a3-8d61-4b91-ad10-febb9b0f40c4.png)


------

### 运行测试gif：这次可以了
>![img](https://api2.mubu.com/v3/document_image/25165450_203e8f41-2760-4041-c9c3-14099925ab9a.png)


------

### 闪电技能GA中需要先判断是否实现了 `ICombatInterface` 接口，可以折叠成一个函数

  - 折叠的函数命名为：`EnforcelmplementsCombatInterface`

>![img](https://api2.mubu.com/v3/document_image/25165450_3f57c88d-f434-494e-f766-7d0497da0b3a.png)


------

### 我们现在需要设置角色身上的持续释放技能的bool，当然不能直接拿，之前我们创建了接口函数，但是还没有蓝图实现

- 之前在这里创建
>![img](https://api2.mubu.com/v3/document_image/25165450_d4ec9c53-01c7-4ea5-952e-c93b216ba619.png)

- 蓝图实现
>![img](https://api2.mubu.com/v3/document_image/25165450_a91fac57-35ba-4f21-ccde-2c98e88e5fc1.png)


------

### 当播放蒙太奇后，立即设置状态
>![img](https://api2.mubu.com/v3/document_image/25165450_0558648a-f82b-44be-f85a-18e9c2dc3289.png)


------

#### 当然结束技能时也需要设置回 false


------

### 但是现在有一个问题，我们释放技能的时候可以移动


------

#### 需要在释放技能后禁用移动


------

##### 可以使用移动组件禁用
>![img](https://api2.mubu.com/v3/document_image/25165450_55a573ed-799d-4012-9f0f-9034699cdb51.png)


------

#### 在松开按键后也需要 启用移动组件，但是没有启动的API，只有设置移动模式的API
>![img](https://api2.mubu.com/v3/document_image/25165450_327506ee-e5f5-4d6b-fb4f-39a5aa32815a.png)


------

### 测试一下
>![img](https://api2.mubu.com/v3/document_image/25165450_18d93a69-f8bc-4bfe-fdf1-b92877f3f43c.png)


------

#### 有一个问题：我们在关闭之后再开启，没有启用 `MotionWarping`

  - 因为还没有接收到 `MotionWarping` 时，就已经触发了后面的逻辑，然后再接收的话，已经不起作用了
>![img](https://api2.mubu.com/v3/document_image/25165450_28e1e13e-086a-4444-dda4-277e1194d218.png)


------

### 我们使用 `WaitGameplayEvent` 来触发操作
>![img](https://api2.mubu.com/v3/document_image/25165450_a9931ee3-ade1-408d-ac05-7a5fec1ae650.png)


------

### 运行测试gif：使用技能后，再使用，依旧会触发 `MotionWarping`
>![img](https://api2.mubu.com/v3/document_image/25165450_42d89ef2-99db-4495-c220-b39a133a3acc.png)


------

### 下面是整理成函数


------

#### 将结束的部分整理成一个节点 

  - 函数命名为：`PrepareToEndAbility`

>![img](https://api2.mubu.com/v3/document_image/25165450_d6dc3c96-3845-4c5b-d621-aef0f9bcecce.png)


------

#### 开始的部分也整理成函数

  - 函数命名为：`InShockLoop`

>![img](https://api2.mubu.com/v3/document_image/25165450_579a44f4-b99e-4785-ed83-844796f0c421.png)


------

#### 设置FacingTarget 的部分也是

  - 函数命名为：`UpdateFacingTarget`

>![img](https://api2.mubu.com/v3/document_image/25165450_0633f3f7-5519-40ac-980b-ad816ece31c2.png)

___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
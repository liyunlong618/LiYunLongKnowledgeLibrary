___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 159 计算部分抽象静态函数；为火球添加重力；使用抛射物组件的追踪导航组件

___________________________________________________________________________________________

## 处理关键点

1. 使用抛射物组件上的追踪导航组件
    - 制作技能追踪敌人效果 ： `在 `ProjectileMovement` 组件上，有一个寻敌组件 `HomingTargetComponent` 是一个 `U类的弱指针组件` ，可以保存敌人的根组件的弱引用
    - 在 `ProjectileMovement` 组件上，使用 `追踪敌人` 类型的步骤：
      - 先判断目标是否有 `SceneComponent` 
        - 若有目标有，直接设置 `HomingTargetComponent = SceneComponent`
        - 若没有 `SceneComponent` ，需要New一个（注意GC），并设置new出来的 `SceneComponent` 的位置
      - 设置归航加速度， `HomingAccelerationMagnitude` （可以设为随机值）
2. 使用 `NewObject` 生成组件
    - 直接生成的不用注册
    - 生成后Attach到Actor上需要注册
    - 使用 `new` 时需要注意 GC

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[2. Spawning Multiple Projectiles_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=115&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[3. Homing Projectiles_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=116&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 上一节我们制作了生成火球角度的计算函数，但是这只是角度的计算部分，放在生成里面会比较冗余，打算放到蓝图函数库中，做成一个 `静态函数` ，这样也方便别的地方使用


------

### 蓝图函数库中创建两个静态函数，一个返回 `FRotator` 数组，一个返回 `FVector` 数组（一个角度版，一个向量版）方便使用

  - 函数分别命名为：`EvenlySpacedRotators` 和 `EvenlyRotatedVectors`

  - 包含四个变量：

    - 一个正前方的向量

    - 一个是轴

    - 一个是技能范围角度

    - 一个是生成火球的数量

>![img](https://api2.mubu.com/v3/document_image/25165450_383862b6-b442-4fbd-d44e-97f8e5992e9e.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_3f4cd7b5-e7d5-4e14-e2e1-a2ef8c6af2cb.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_6d20b5f0-2c7a-4f96-b0e5-a752110c0e26.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_9ebb3fd1-25e4-42f0-c043-c21e5a529790.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_ebd2c8f1-0636-4228-d1dc-c77f3b744e82.png)


------

### 这样我们在原来的位置只需要调用这个静态函数，传参，就可以获得一个向量的数组
>![img](https://api2.mubu.com/v3/document_image/25165450_8c3e7297-a687-41d7-afdb-0649f59575dc.png)


------

#### 接下来遍历这个向量数组，做和原来一样的事
>![img](https://api2.mubu.com/v3/document_image/25165450_8a61967d-d696-453a-d344-9977d35a2cf0.png)


------

### 也可以使用FRotator的版本
>![img](https://api2.mubu.com/v3/document_image/25165450_92f1f45a-a093-4b4b-84de-4ce9918b9f07.png)


------

### 运行测试结果
>![img](https://api2.mubu.com/v3/document_image/25165450_1ba8d415-0c03-48ac-dcab-b20eba4c7b70.png)


------

### 接下来参考之前生成火球的函数，只是用FRotator数组遍历，然后生成火球
>![img](https://api2.mubu.com/v3/document_image/25165450_36e17cc2-8f96-4e11-ccd1-42f5d9302dfe.png)


------

### 运行测试gif：会生成多个火球
>![img](https://api2.mubu.com/v3/document_image/25165450_a0f69125-43d9-4f20-e2d4-e4f74c0c8319.png)


------

### 后续会使用角度覆盖原角度，然后为火球添加重力，并且添加寻敌的导弹效果
>![img](https://api2.mubu.com/v3/document_image/25165450_8cea8b95-8c49-40b2-f512-c9af28293ce3.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_21baa744-9b7b-4c9f-b32c-0c128ad5582e.png)


------

### 下一节


------

### 可以为火球添加重力效果
>![img](https://api2.mubu.com/v3/document_image/25165450_9670c898-af51-4d4e-9a79-559ca104a7b5.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_820897dd-69dd-4cb0-8103-60d135bd2c32.png)


------

### 加上覆盖俯仰轴Pitch，就可以有抛物线了（但是问题是有一点近）
>![img](https://api2.mubu.com/v3/document_image/25165450_8cea8b95-8c49-40b2-f512-c9af28293ce3.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_d0e70285-eb2e-4efa-df54-2952fa969680.png)


------

### 稍微增加火球的移速和初速度，就可以让火球打得更远
>![img](https://api2.mubu.com/v3/document_image/25165450_f251bb68-9224-4221-9c19-9f766373712b.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_07343e6c-b30c-4e7f-fd17-07c98bf1d975.png)


------

### 但是这就带来了一个问题，我们如果站得远，点击敌人就无法攻击到敌人
>![img](https://api2.mubu.com/v3/document_image/25165450_abd425a6-fd60-4d8a-ae5b-c4baea56a7ab.png)


------

#### 换言之，现在想要制作寻敌效果了（当火球发射出去后会寻找敌人并动态调整自己的位置）
>![img](https://api2.mubu.com/v3/document_image/25165450_426a50a8-bf18-4936-f149-c9aa6afec052.png)


------

### 我们先将击中后拿到的敌人的指针存为变量，然后将指针数据，作为实参传入函数
>![img](https://api2.mubu.com/v3/document_image/25165450_4e6fd235-8a07-42bb-acdf-23c1c75cc3ad.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_e16e82a4-3688-4ba7-eb9a-52f7d1d40031.png)


------

### 在 `ProjectileMovement` 组件上，使用 `追踪敌人` 类型的步骤：


------

#### 在 `ProjectileMovement` 组件上，有一个寻敌组件 `HomingTargetComponent` 是一个 `U类的弱指针组件` ，可以保存敌人的根组件的弱引用

>![img](https://api2.mubu.com/v3/document_image/25165450_923801a4-b621-48df-e7ed-fa54663d8078.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_1aa93caa-6679-4bc8-cd2b-a98c850e9775.png)


------

#### 但是有一个问题，如果击中的是敌人，可以判断该目标是否实现了接口，来获取目标的根组件，但假如，我们是按shift使用技能，没有目标，怎么办？

  - 我们可以使用 `NewObject` 在目标地点创建一个新的根场景组件
>![img](https://api2.mubu.com/v3/document_image/25165450_6971dd80-d29b-404f-853e-fb2b3d4d4dda.png)


------

#### 但是创建场景组件会带来一个新的问题，就是这个NewObject创建出来的组件，不会被回收和GC，何时回收？怎么回收？

  - 我们可以在火球Actor上创建一个SceneComponent组件的指针来指向它，这样它就有owner了，可以GC


------

##### 火球Actor上，创建组件指针，保存创建出来的 `SceneComponent`

  - 命名为，`HomingTargetSceneComponent`

>![img](https://api2.mubu.com/v3/document_image/25165450_d98717fb-c04f-4ae7-8930-64aaebf32b7c.png)


------

#### 当没有目标时， `NewObject` 一个新的 `SceneComponent` ，保存在 `火球Actor` 上，然后 `ProjectileMovement` 组件上的寻敌组件 `HomingTargetComponent` 的 `U类的弱指针组件` 指向自身的 `SceneComponent`
>![img](https://api2.mubu.com/v3/document_image/25165450_0600a17b-cf12-4388-ea88-cd70de14bab2.png)


------

#### 接下来，我们来设置火球的归航速度，也就是 `ProjectileMovement` 组件上的 归航加速度大小 `HomingAccelerationMagnitude`

  - 我们给归航加速度一个随机值


------

##### 在GA上创建两个参数，分别是归航的最大加速度和最小加速度

  - 命名为：`HomingAccelerationMin` 和 `HomingAccelerationMax`

>![img](https://api2.mubu.com/v3/document_image/25165450_2154a8b2-59b3-4dd8-ba4f-ef5ab8b62002.png)


------

##### 设置归航速度
>![img](https://api2.mubu.com/v3/document_image/25165450_c227c6e9-293d-4434-ab65-23dd4258b448.png)


------

#### 最后我们需要设置 `ProjectileMovement` 组件类型为 `寻敌类型` ，这样就完成了设置
>![img](https://api2.mubu.com/v3/document_image/25165450_33c79421-162f-4961-8e9d-27e4723c5592.png)


------

### 可以在火球GA上创建一个bool类型变量标注生成的火球的类型为 `追踪敌人` 类型

  - 命名为：`bLaunchHomingProjectiles`

>![img](https://api2.mubu.com/v3/document_image/25165450_746a5d57-4f8b-4eb0-8394-fff2d76b24fc.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_c24161ae-1161-4232-dfb3-e0825511f243.png)


------

### 运行测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_5a16bbef-b3be-435f-fdff-ec2820dc697f.png)

- 有点问题

  - 瞄准敌人时：

    - 如果敌人离得过近，就无法击中敌人

    - 如果敌人离得太远，就无法打到敌人

  - 不瞄准敌人时，方向不对


------

### 看下代码
>![img](https://api2.mubu.com/v3/document_image/25165450_d02c1628-6b12-4fd3-a38a-080ea417c193.png)

- 我们生成了组件，但是不瞄准敌人时，并没有设置该组件的位置


------

#### 在生成组件后，设置组件的位置
>![img](https://api2.mubu.com/v3/document_image/25165450_e456b8d1-ac5f-4529-a77c-191d40cd0124.png)


------

### 运行测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_461a198a-3222-40c0-aba3-10ef6d74a98b.png)

- 无法击中过远的敌人（这个是重力和速度不够导致的）


------

### 设为更快的速度
>![img](https://api2.mubu.com/v3/document_image/25165450_c937165a-425c-4181-b400-01eded037351.png)


------

### 运行测试gif：可以击中敌人了，攻击不到过远的单位
>![img](https://api2.mubu.com/v3/document_image/25165450_0eabe160-5cc9-42bd-9269-a68e44b9cec3.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_d603d97e-a80b-40fb-e2a9-6dabdc01f7bc.png)


------

### 如果关闭重力之后，肯定可以击中，但是攻击范围就变为无限远了


------

### 将速度调为正常的范围（这个其实影响的就是攻击距离）


------

### 目前测试完成，真正释放火球的技能时，技能肯定是和技能等级挂钩，所以需要改一下逻辑
>![img](https://api2.mubu.com/v3/document_image/25165450_a45929cc-5f9a-4966-c1f9-bb0156aa3c73.png)


------

### 运行测试gif

  - 一级1火球；二级2火球

>![img](https://api2.mubu.com/v3/document_image/25165450_5ccdfdbe-610c-4071-8448-238f9012efb8.png)


------

### 我们之前为了测试1级火球的效果，降低了1级火球的MP消耗，2级消耗的有点多，所以需要修改下曲线表格
>![img](https://api2.mubu.com/v3/document_image/25165450_7cb45cee-f647-4d2f-f51e-365594ccb927.png)


------

### 有一个小挑战，有时间的话可以搞一下，火球术的技能描述，让它变得更贴切


------

### 这里有一个bug现在：当我们 点击 空气墙时，会崩溃
>![img](https://api2.mubu.com/v3/document_image/25165450_cc98ecd1-a5ea-494b-9969-fdccb3742b3b.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_f46ec525-627e-4be5-c621-31bd2ab10eab.png)


------

### 需要为这个目标，判断空指针
>![img](https://api2.mubu.com/v3/document_image/25165450_59a4af18-010b-4c87-a62c-c85e7b18b5f4.png)


------

### 火球对于太近的敌人难以击中；且会漂浮在空中（导致音频一直触发），以下是来自后面的修复GAS_161

<details>
<summary>视频链接</summary>

[5. Invoke Replicated Event_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=118&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

- 音频问题的修复：
>![img](https://api2.mubu.com/v3/document_image/25165450_b170f62a-82c6-4086-e324-ed8b80b85509.png)

- 敌人太近难以击中的修复：
>![img](https://api2.mubu.com/v3/document_image/25165450_e4855062-fcfb-4d73-bd0c-2c6d52d08543.png)

- 测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_6f1be903-ea08-410e-fcbc-5c69f189b957.png)

- 当攻击空气墙时，不会朝目标发射火球

  - 因为空气墙的碰撞通道的问题
    - 没有检测Visibility

>![img](https://api2.mubu.com/v3/document_image/25165450_b1bf2685-3cd2-439d-b9e8-fae68d26a57b.png)

  - 设置碰撞通道
>![img](https://api2.mubu.com/v3/document_image/25165450_ef66b999-9532-4aaf-fbdd-0595d440d8e7.png)

- 当点击空气墙时，会漂浮在这里

>![img](https://api2.mubu.com/v3/document_image/25165450_e77951f7-12a9-45fb-8b66-e987d97d4311.png)

  - 这个原因是：攻击基于Visibility，Overlap则不是，所以就卡在了这里

- 顺便检查声音是否消失

- 可以单独设置，摄像机面朝的这一堵墙的位置，或者将这一堵墙碰撞检测通道Visibility改为忽略
>![img](https://api2.mubu.com/v3/document_image/25165450_6e4b37a6-cb7d-48bf-8834-7996f48f6819.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_8179c457-8686-47f8-a1be-93983d9d9e1d.png)

- 可以放到一个文件夹里
>![img](https://api2.mubu.com/v3/document_image/25165450_d1233656-8fde-4e9e-83be-a6d4ba0cf71f.png)

___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
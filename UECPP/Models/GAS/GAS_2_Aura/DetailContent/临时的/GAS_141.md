___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 141 在服务器处理消费技能点升级技能等级和解锁技能，立即Mark同步一次，然后使用Client将结果同步到客户端

___________________________________________________________________________________________

## 处理关键点

1. 在服务器修改技能GA Spec后需要立即同步一下
2. 如果需要遍历技能列表需要加技能列表锁！！
3. 关于RPC的拓展：
   - 当客户端直接调用ASC中的RPC_Server函数然后在服务器上(也就是函数体内)调用GetActivableAbilities()遍历时,服务器如何知道遍历的是哪个ASC组件的GetActivableAbilities()呢？
     - 服务器知道是谁调用，因为服务器可以根据调用的上下文拿到GetOwner
4. 有时间查查：虚幻中的上下文好多都是什么时候配置的？都有哪些上下文？

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[22. Spending Spell Points_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP?p=89&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________



------

### 这一节，我们需要处理 花费技能点的逻辑

  - 当对一个已解锁的技能花费技能点时，会提升技能等级

  - 当对一个未解锁的技能花费技能点时，会解锁并学习该技能

  - 上面两种情况执行后都应该技能点-1


------

#### 同时，右侧的详情描述面板，应该显示当前等级的技能详情和下一级的技能详情，这个使用 `富文本` 来制作

>![img](https://api2.mubu.com/v3/document_image/25165450_553127ac-5b9c-49e0-e6fc-8d67de7d4942.png)


------

### 这一节主要解决，花费技能点的问题


------

### 当我们点击花费技能点时，调用一个BlueprintCallable函数，来触发一系列的逻辑

  - 函数命名为，`SpendPointButtonPressed`

>![img](https://api2.mubu.com/v3/document_image/25165450_65fb0a97-c8d9-4b53-b46f-17fc54493df3.png)


------

### 当我们触发了该函数，底层应该是调用ASC组件中的逻辑，（因为点击技能点调用ASC这时的逻辑触发应该在客户端）ASC使用RPC_Server到服务器修改技能


------

#### 所以需要先在ASC中创建RPC_Server函数

  - 函数命名为，`ServerSpendSpellPoint`

>![img](https://api2.mubu.com/v3/document_image/25165450_dc5602cf-bb31-421b-ec71-fb234d5f2e78.png)


------

### `RPC_Server` 函数中，此时执行的是 升级/解锁 技能的逻辑， `GetSpecFromAbilityTag` 返回的 `Spec指针` 不为空，说明该技能在已激活的技能列表中，说明已学习，那么需要获取该技能的 `状态Tag` ，分为以下几种情况：

  - 待解锁状态
    - 需要切换成未锁定状态

  - 未锁定 或者 已装备状态
    - 需要该技能等级+1

>![img](https://api2.mubu.com/v3/document_image/25165450_56729072-508e-485f-846c-33589819b88d.png)


------

#### 关于 `RPC` 调用的问题

>![img](https://api2.mubu.com/v3/document_image/25165450_fb078e4b-7791-4888-f243-4ea49eb3536a.png)


------

### 除此之外还需要花费一个技能点


------

#### 我们可以调用之前创建的函数 `AddToSpellPoints` 来添加技能点

>![img](https://api2.mubu.com/v3/document_image/25165450_edbe930d-a671-4740-88f3-f9ac937019c3.png)


------

#### 如果角色实现了接口，就调用接口函数，技能点-1

>![img](https://api2.mubu.com/v3/document_image/25165450_008eeb34-52df-4aaa-f810-2cbb62a13b63.png)


------

### 接下来需要发给 `ClientRPC` 通知客户端已修改技能点

  - 我们之前创建了RPC_Client函数，然后广播了AbilityTag和StatusTag

>![img](https://api2.mubu.com/v3/document_image/25165450_cb4b928e-92b0-4ff8-c3ea-232e58e70761.png)


------

### 我们需要修改ASC的 `RPC_Client` 函数和广播 `ClientUpdateAbilityStatus` ，多传递一个技能点的参数

>![img](https://api2.mubu.com/v3/document_image/25165450_fbc9f69f-48c6-42ce-b8c7-d3b2f1e8cbb5.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_878f3c78-9d88-4ed9-f51f-22665664f85e.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_4ccdc270-2505-47ca-a6f4-2792b62f15dd.png)


------

#### 之前这里调用的时候，需要多加一个 `参数`

  - 虽然这里他用的是1，但是我觉得应该获取变量

>![img](https://api2.mubu.com/v3/document_image/25165450_af1123c2-f261-4561-e385-8465daac0660.png)


------

### 然后调用 `RPC_Client` 更新到客户端

>![img](https://api2.mubu.com/v3/document_image/25165450_e7a717d4-623b-49df-d436-d11918647dc2.png)


------

### 因为我们修改了 `FGameplayAbilitySpec` 所以我们需要调用 `API` 立即向客户端同步一次

>![img](https://api2.mubu.com/v3/document_image/25165450_3de76ace-7955-4037-a488-6c94ce3b5a8e.png)


------

### `回调lambda` 中也必须 增加 `变量`

>![img](https://api2.mubu.com/v3/document_image/25165450_f7920827-215b-4abf-9eb6-71404d24e77a.png)


------

### 这样在更新技能时，在这里也会相应的更新每个技能的等级（但是还没处理，后面使用）


------

### 在 `SpendPointButtonPressed` 函数中调用 `ASC` 的 `RPC_Server` 函数

>![img](https://api2.mubu.com/v3/document_image/25165450_2e10ecb8-62f1-4dc1-a2c5-ce4138c36d09.png)


------

### 在 ***WBP_SpellMenu*** 中，在点击按钮时，调用 BlueprintCallable 函数 `SpendPointButtonPressed`

>![img](https://api2.mubu.com/v3/document_image/25165450_05c03404-a30b-4998-bede-4f6ad4466473.png)

- 因为要使用`BP_SpellMenuWidgetController`所以需要确保设置了小部件的WidgetController后使用


------

### 此时效果gif

>![img](https://api2.mubu.com/v3/document_image/25165450_87b295fa-c7ae-4638-e4ff-9cc41e7acf76.png)

- 升级然后花费技能点升级技能

- 可能不太明显，我们在激活技能时，打印技能等级

>![img](https://api2.mubu.com/v3/document_image/25165450_e6c227d4-f3a6-40ae-fa77-a18425605cde.png)


------

### 升级如果花费技能点解锁技能，还不能更新，因为我们为 `GA` 设置了新的 `状态` ，但是并 `没有修改广播的值!`

>![img](https://api2.mubu.com/v3/document_image/25165450_bc711f02-5af5-42c1-8e3e-dd46a6cdd125.png)


------

#### 需要在更新完 `GA的状态Tag` 后，更新要广播的 `Status`

>![img](https://api2.mubu.com/v3/document_image/25165450_b42b5904-3bbe-4bcc-e29b-ef3c562e3eb2.png)

- 然后在广播就会得到正确的 `Status状态` （也就是可以解锁技能了）


------

### 测试一下，解锁技能gif

>![img](https://api2.mubu.com/v3/document_image/25165450_fefe8261-7d5a-4d1c-8eee-9a42cc8ab726.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_19854fbd-1289-4c20-ac1e-3611f9eb17a2.png)


------

#### 多人模式LS/DS下也测试一下，应该没有问题


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 139 使用广播本地根据技能状态和技能点处理花费技能点按钮和装备技能按钮的启用和禁用

_________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[20. Spell Menu Buttons_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP?p=87&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 将NavMesh 向前移一段距离，（让玩家所在的区域没有导航，这样AI就无法到达玩家位置，就会在原地不动）为了方便测试

>![img](https://api2.mubu.com/v3/document_image/25165450_9106f1d4-bef7-4cde-ab64-15b04dae2ab9.png)


------

### 本节我们将处理这两个按钮的 `启用` 和 `禁用` 状态

>![img](https://api2.mubu.com/v3/document_image/25165450_23321d66-3c64-4c42-91e0-046565321725.png)


------

### 大致有下面这几种情况

  - 当菜单打开是默认禁用，这两个按钮

  - 当点击一个已经激活的技能时（ `已解锁状态` 和 `已装备状态` ），可以使用技能点提升该技能的等级，加点按钮应该启用，同时，装备技能按钮也应该启用，因为可以装备该技能

  - 选定 `技能图标` 的状态

    - 锁定状态

      - 加点按钮——禁用

      - 装备技能——禁用

    - 待解锁状态

      - 加点按钮——启用

      - 装备技能——禁用

    - 已解锁状态（未装备）

      - 加点按钮——启用

      - 装备技能——启用

    - 已装备状态

      - 加点按钮——启用

      - 装备技能——启用

  - 除此之外，当 `技能点数 == 0` 时，也 不应该启用 该按钮


------

### 按钮改下名字

>![img](https://api2.mubu.com/v3/document_image/25165450_0007aa6c-f8c0-4f87-8ba7-99f2c98535fd.png)


------

### `构造` 时，禁用按钮

>![img](https://api2.mubu.com/v3/document_image/25165450_a80fb6bb-2812-4359-eb38-7fc955a37fd7.png)


------

### 接下来将，在 `WidgetController` 中创建委托，广播这两个按钮开关的 bool ，在点击技能图标时，可以调用一个 `blueprintCallable` 函数，可以传入 `AbilityTag` ，然后进行对比

  - **至于为什么只同步这两个 `bool` ? 多余的数据不要随随便便同步**


------

### 下面我们将 拆分步骤 来完成这些需求


------

#### 当我们选中技能图标时，调用一个 `blueprintCallable` 函数，传入 `AbilityTag` ，这样可以知道我们选择的是哪个技能图标


------

##### `SpellMenuWidgetController` 中创建蓝图可调用函数

  - 命名为，`SpellGlobeSelected`

>![img](https://api2.mubu.com/v3/document_image/25165450_fab88c86-55a3-46dd-cf30-20513dc889dd.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_4a8ef264-c30e-408f-c9ff-631f26dea32f.png)


------

##### 在点击时，调用

>![img](https://api2.mubu.com/v3/document_image/25165450_b796e09f-cf69-45eb-82a5-ac994d1bd1fe.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_15e78076-c5fb-4b71-ffd1-072c34c56265.png)


------

#### 接下来声明一个含有两个 `bool` 的动态多播

  - 命名为，`FSpellGlobeSelectedSignature`

  - **委托实例(蓝图实现)**，命名为，`SpellGlobeSelectedDelegate`

>![img](https://api2.mubu.com/v3/document_image/25165450_c2462d00-64c6-492c-a67a-94086fbce735.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_84c4631f-c5e0-4972-8fcd-b8324d2d022c.png)


------

#### 接下来我们需要考虑在何时进行广播？

  - 先在**点击技能图标**时，拿到**技能点**，通过**技能点**和**技能状态**判断该执行的策略，这时**分情况 广播**不同数据


------

#### 这是有一个问题，我们需要一个 `GameplayTag` 来标注，无技能的状态

  - 需要创建一个 `GameplayTag` 


------

##### 创建标注无技能状态的 `GameplayTag`

>![img](https://api2.mubu.com/v3/document_image/25165450_87382c62-f344-4de5-88b9-ab12b25cd06d.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_5a2dfaa7-449c-4c9d-ff07-f970799d659c.png)


------

#### 折叠：回顾一下，之前在ASC中创建的函数 `GetStatusFromSpec` 和 `GetSpecFromAbilityTag`

>![img](https://api2.mubu.com/v3/document_image/25165450_4c200dbf-e0e9-4c98-8b5a-c41be9fcbede.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_0e36bbf7-15b4-447a-adde-f7277c924546.png)

- 我们是在当前已激活的能力列表中遍历，然后返回该技能的GA Spec，也就是说如果该技能没有学习，是不会在列表中的，也就是会返回空指针


------

#### 使用 `AbilityTag` ，对技能状态进行归类

  - 有几种情况：当一下一种情况发生时，判定该技能状态等同于 `锁定状态` （相当于广播两个false，也就是两个 **按钮** 都 **不启用** ）

    - `AbilityTag` 失效

    - AbilityTag == None，也就是我们的 `无技能` 状态标记

    - 调用ASC上的 `GetSpecFromAbilityTag` 函数，返回的Spec 有效（说明已经学习了该技能）

>![img](https://api2.mubu.com/v3/document_image/25165450_8fd41cb2-abf0-471c-daac-77d21070c25b.png)


------

#### 需要调用ASC组件中的函数 `GetStatusFromSpec` 传入 `Spec` 获取 `技能状态`

  - 有个问题，因为 `GetSpecFromAbilityTag` 函数中涉及到fro循环遍历，不宜多次调用，所以 **需要暂存结果，以便后续多次使用**

>![img](https://api2.mubu.com/v3/document_image/25165450_1cb6f487-20e2-4f4b-97c4-6e4d563c066c.png)


------

#### 下面需要创建两个 `bool` ，并根据技能点和技能状态，设置 `bool` （因为业务逻辑比较多，应该搞成一个 `函数` ，通过引用传参，进行内部修改值，供给外部使用）

- 创建函数命名为，`ShouldEnableButtons` ，然后根据情况设置 `bool`

>![img](https://api2.mubu.com/v3/document_image/25165450_a47e5cea-1858-4edd-8043-75980e11caf7.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_274b0ab9-9274-4999-a809-9279a36fde53.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_4d0e38fb-66af-4112-a38b-dab2eefdf16a.png)


------

#### 点击技能函数 `SpellGlobeSelected` 中，创建两个局部变量 `bool` ，调用上面创建的函数，修改值，然后进行广播（ `注意顺序` 不要搞错了）

>![img](https://api2.mubu.com/v3/document_image/25165450_ab595715-f8e6-4474-9264-862a43e0d18a.png)


------

### 此时运行游戏，断点测试，看结果是否正常

>![img](https://api2.mubu.com/v3/document_image/25165450_903cfabf-bd72-42d5-a9c7-c8fb2ab6c1eb.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_879923b7-df97-4357-e8e4-eb5ce45e6eca.png)


------

### 在打开菜单后进行广播，然后设置两个按钮的启用禁用状态

>![img](https://api2.mubu.com/v3/document_image/25165450_d41ae512-550a-430b-99c1-d5b622d5580c.png)

- 合并函数，命名为，`SetButtonsEnabled`

>![img](https://api2.mubu.com/v3/document_image/25165450_1188af14-3aa9-4eb2-c695-16ba23d65413.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_98197455-46b0-4c37-cb53-22094d339f72.png)

- 构造时也可以使用这个函数初始化了

>![img](https://api2.mubu.com/v3/document_image/25165450_8bcbaad3-bee7-48b7-9854-1573f59a8afb.png)


------

### 此时测试一下结果gif

  - 当我们单击装备的能力时，我们将启用这两个按钮（我初始的技能点是0，所以不会启用加点的按钮，只会启用装备按钮，升1级以后测试结果应该两个按钮都启用）

  - 当我们点击锁定的技能或没有技能球的技能球时禁用这两个按钮

>![img](https://api2.mubu.com/v3/document_image/25165450_33c6ba68-4942-4071-8b7b-e912349e99f0.png)


------

### 有一个报错，当我们运行时点击被动技能图标时，会报错

>![img](https://api2.mubu.com/v3/document_image/25165450_7837a2c2-7989-4e94-b306-bda304d928a5.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_b6457379-abd4-4bab-b1c1-dbc28ff5478b.png)

- 是说我们没有实现被动技能球的 `WidgetControllerSet` 事件，所以技能球没有 `WidgetConreoller`

- 需要设置下

>![img](https://api2.mubu.com/v3/document_image/25165450_c39cff43-c98f-4877-c88c-752f53ef7c77.png)


------

### 现在有一个问题是，当我们选中了一个技能，因为我们是远程攻击角色，所以，我们可能先攻击一个敌人，然后打开 `UI` ，此时飞行的火球把敌人打死，然后升级，但这时，我们选中的技能并不会随之更新按钮的状态（也就是说，在升级时，需要处理广播的逻辑）下一节处理

>![img](https://api2.mubu.com/v3/document_image/25165450_2ec1c51c-3758-42c9-e079-f6f122b4f92f.png)


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
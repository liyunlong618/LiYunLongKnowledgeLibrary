___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 172 使用监听处理闪电链技能释放期间首个目标和其他目标死亡的逻辑，添加判断闪电技能最短触发时间的逻辑

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[18. Electrocute Polish_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP?spm_id_from=333.788.player.switch&vd_source=9e1e64122d802b4f7ab37bd325a89e6c&p=131)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 主要敌人死亡时，结束技能，单个敌人失望时，需要从数组中移除，并取消CueLoop（这部分用委托来做）

  - 为了解耦，可以在接口中创建动态多播，广播死亡的角色


------

#### `ICombatInterface` 中创建动态多播

  - `FOnDeathSignature`

>![img](https://api2.mubu.com/v3/document_image/25165450_5ac68d60-5d45-4849-9333-5d3815228718.png)


------

#### `ICombatInterface` 中创建函数，外部可以获取委托（纯虚）

  - `GetOnDeathDelegate`

>![img](https://api2.mubu.com/v3/document_image/25165450_2aeb817d-259d-4f41-fffb-a063115c4b62.png)


------

#### 角色基类中重写纯虚函数，创建委托并返回

  - `OnDeathDelegate`

>![img](https://api2.mubu.com/v3/document_image/25165450_f018caf5-87ad-4cee-ee28-b6fd2e66cb6f.png)


------

#### 闪电技能中创建两个回调，分别为主要角色死亡和链接角色死亡用（蓝图实现）

  - `PrimaryTargetDied`

  - `AdditionalTargetDied`

>![img](https://api2.mubu.com/v3/document_image/25165450_03ff67ba-9b81-4834-9406-52192cc6ed36.png)


------

#### `TraceFirstTarget` 函数确定了目标，所以需要在这里对目标进行绑定回调

>![img](https://api2.mubu.com/v3/document_image/25165450_80031bb2-2625-4078-a5e6-dbb1c63ba4ea.png)

  - 使用 `IsAlreadyBound` 检查该委托是否准备好了绑定（我觉得是有可能防止点击死了还没销毁的目标）

>![img](https://api2.mubu.com/v3/document_image/25165450_fa1f207e-4949-4ac6-925a-a183b1af81f4.png)


------

#### `StoreAdditionalTargets` 函数查找目标数组，所以需要在这里对单个目标进行绑定回调

>![img](https://api2.mubu.com/v3/document_image/25165450_9dd92b99-38c3-4a4f-e0eb-13148fef2e6e.png)


------

#### 上面绑定了回调，接着需要广播，需要在角色死亡时广播

>![img](https://api2.mubu.com/v3/document_image/25165450_fe8f5fa0-1501-45c4-8bbc-adb6d57d2215.png)

>![img](https://api2.mubu.com/v3/document_image/25165450_9cc9aa7d-a521-4cf4-ddb5-2b8acb601190.png)


------

#### 蓝图中实现两个回调函数


------

##### 主要目标死亡时，结束技能，移除特效，清空计时器相关参数
>![img](https://api2.mubu.com/v3/document_image/25165450_8968b368-3935-4b6a-e90c-51a758265e2b.png)


------

##### 次要目标死亡时，将目标从数组中移除
>![img](https://api2.mubu.com/v3/document_image/25165450_3536d06c-cda9-4e2d-bcbf-6d6f372907d0.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_a2b5ae0f-133b-4e3c-bfed-b3dd0918db4f.png)


------

#### 计时器结束技能的逻辑中，直接调用提交CD
>![img](https://api2.mubu.com/v3/document_image/25165450_2b0da78c-2b11-4b28-e76e-3a60e6fc5581.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_141ed280-2ddf-4ba8-c59d-c40a0a590eab.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_36624baf-2c2c-4a31-c641-a66ecbf2a1ba.png)


------

### 这是运行有一个bug：当我们攻击导致一个主要目标死亡时，我们再次攻击地板，会导致之前的次要目标都受到伤害（也就是次要目标数组没有清空）
>![img](https://api2.mubu.com/v3/document_image/25165450_5bd605c1-b289-4bab-f9e5-a2a1685c37e6.png)


------

#### 同时还有报错
>![img](https://api2.mubu.com/v3/document_image/25165450_6ed64e27-a0c4-4ebe-a678-df27cc33be69.png)


------

##### 先解决需要清空数组的问题
>![img](https://api2.mubu.com/v3/document_image/25165450_2ce9b6b5-b149-4a6e-cc4b-f3cdd870ab63.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_7662aa7f-b7eb-4298-f375-b4f00b6ddd1c.png)


------

###### 运行测试gif，数组被清空了
>![img](https://api2.mubu.com/v3/document_image/25165450_9189bfef-cc8a-4023-e2cc-940e256e97fa.png)


------

##### 解决报错的问题

  - 看提示说，报错是因为，在遍历应用GE时，目标空指针
    - ASC也可能空指针

  - 所以需要判空


------

###### 改为使用变量然后判空
>![img](https://api2.mubu.com/v3/document_image/25165450_405bb5c4-d564-4f3b-a1f0-71453d6bed07.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_db058c75-dd2f-468d-c74f-35d8121e93bd.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_3b62051a-d8c8-4b08-e3e0-57b4596f2f03.png)


------

###### 在我们释放技能按键后，也需要执行结束技能的一系列逻辑
>![img](https://api2.mubu.com/v3/document_image/25165450_a1fa01f9-c21e-4ce9-ea9e-0c320a10d8a3.png)


------

###### 运行测试gif：解决了报错问题
>![img](https://api2.mubu.com/v3/document_image/25165450_cfac435d-f21b-4391-c617-29413f485704.png)


------

### 但是没有显示冷却UI

  - 因为技能结构体中没有配置 `CD Tag`


------

#### 配置技能冷却Tag
>![img](https://api2.mubu.com/v3/document_image/25165450_a8998bb8-c80d-4ee5-98db-ad6923fc9b5b.png)


------

### 还有一个bug：当我们点击按键后立即松开，会导致进入CD状态，甚至没有播放完蒙太奇
>![img](https://api2.mubu.com/v3/document_image/25165450_34a3624a-b463-4f67-d68c-7d3b65010b26.png)

- 所以需要一个最短触发时间


------

#### 设置最短触发时间

>![img](https://api2.mubu.com/v3/document_image/25165450_b5502d9d-1337-4836-a8d4-d7631cca8f99.png)

  - 记录一下，这个异步节点返回的按键时长，记得结束技能时清空
>![img](https://api2.mubu.com/v3/document_image/25165450_b64f2782-f96a-4648-a10a-cb59347411a5.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_ea6322d5-9b7e-4531-e151-9ec128a13a93.png)


------

#### 当没有到最短按键时间时，Delay到最短时间然后结束技能
>![img](https://api2.mubu.com/v3/document_image/25165450_d30dcf46-e6ce-4970-f471-4e695ca349f8.png)


------

##### 因为最短时间肯定能播放完蒙太奇，所以肯定可以看到光束
>![img](https://api2.mubu.com/v3/document_image/25165450_6e44fec1-162b-4867-ef61-a309cbc41fb3.png)


------

### 最后一步，根据我们的实际等级，确定 链接目标数量
>![img](https://api2.mubu.com/v3/document_image/25165450_b86e16f0-6596-4bfb-9da9-5a09ce046981.png)


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
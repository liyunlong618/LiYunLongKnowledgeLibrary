___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 137服务器中在角色升级时遍历技能，找到合格的技能，然后学习（在服务器），并同步给客户端UI

___________________________________________________________________________________________

## 处理关键点

1. **技能列表锁** `FScopedAbilityListLock`

2. 当角色升级时，因为属性开启了属性复制，所以会同步到服务器，在服务器根据 `技能可以学习的等级` 遍历技能，然后学习，再使用RPC_Client同步给指定客户端

   - 这样有两个时间节点在同步数据分别是：

     - 初始化时

     - 升级时

3. 当我们修改了技能，然后更改了该能力的某些内容，有可能不会马上更新同步到客户端，那么需要调用API 强制更新，这样可以立即复制该GA_Spec到客户端，不用等到下一轮同步周期

   - 使用API：`MarkAbilitySpecDirty(传入该GA的Spec);`

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[14. Ability Level Requirement_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=81&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[15. Update Ability Statuses_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=82&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[16. Updating Status in the Spell Menu_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=83&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 当我们升级时，加入我们解锁了图中的技能，那么当到达指定的等级，那么该技能的图标也会被解锁，可以学习，技能等级应该在 `FAuraAbilityInfo结构体` 中并可以在蓝图中配置，ASC组件也应该有一个检索的函数
>![img](https://api2.mubu.com/v3/document_image/25165450_41a7da06-419c-4f45-ab10-d56a5035d166.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_579d1ca0-6365-439f-b0ad-850621f748af.png)


------

### 在结构体中添加两个变量

  - 一个是当前技能的 `GA Class`
    - 命名为，`Ability`
  - 一个是解锁该技能需要的等级
    - 命名为，`LevelRequirement`
>![img](https://api2.mubu.com/v3/document_image/25165450_95928e39-d1b6-4e22-941d-297d4fccee42.png)


------

### 当角色升级时，ASC组件需要一个可以访问这个数据资产的方法，需要找与一个服务器的位置存放数据资产

  - 打算放在GM中


------

### 在GM中创建持有数据资产的智能指针
>![img](https://api2.mubu.com/v3/document_image/25165450_015516a7-2da7-44d0-9338-bb0472fa75e9.png)


------

### 蓝图函数库中创建获取数据资产的函数
>![img](https://api2.mubu.com/v3/document_image/25165450_7fdd5870-f4a7-4318-9cd0-5d38ca2804cb.png)


------

### 蓝图技能结构体中设置火球 `可以学习技能的等级为1`
>![img](https://api2.mubu.com/v3/document_image/25165450_eaf51f95-063c-4742-aa7f-140e3ce96d6d.png)


------

### 蓝图GM中配置
>![img](https://api2.mubu.com/v3/document_image/25165450_2f5e756b-cd13-498c-d9cd-aff6c2d4bfbb.png)


------

### 既然需要别的技能，我们需要先创建一个新的技能，触发先是临时打印逻辑

  - 命名为，`GA_Electrocute`
>![img](https://api2.mubu.com/v3/document_image/25165450_a45214fe-8022-4a41-c5d1-5aa66a698c81.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_90df708b-50de-4c8f-c365-75598e0eb1dc.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_eeeb1980-60c4-4541-9157-9dd8e6148a4c.png)


------

### 但是我们缺新的技能的技能Tag
>![img](https://api2.mubu.com/v3/document_image/25165450_d2b85bfc-4acb-4a07-897f-6578ca01b90d.png)


------

#### 创建新 `AbilityTag`

  - `Abilities_Lightning_Electrocute`
>![img](https://api2.mubu.com/v3/document_image/25165450_794fc253-da87-46b2-9315-8ea1b1cb5b75.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_e890d640-7e08-49a3-e549-cfa8c31950d4.png)


------

#### 配置技能Tag
>![img](https://api2.mubu.com/v3/document_image/25165450_112d2f11-3c61-4d93-f96c-a7c47a40d4a9.png)


------

### 蓝图技能信息结构体中，添加新的技能
>![img](https://api2.mubu.com/v3/document_image/25165450_c92b2cda-e542-4368-b9be-e3ad7ec624a7.png)


------

### UI中配置
>![img](https://api2.mubu.com/v3/document_image/25165450_f35cf054-bf83-43d7-e2c9-301003fcd15a.png)


------

### 现在每次升级时，都希望图标可以自动更新，请看下一节
>![img](https://api2.mubu.com/v3/document_image/25165450_554f97cb-389b-4e19-d4e6-32b456592430.png)


------

### 下一节


------

### 只有ASC可以学习技能，所以需要在ASC上创建函数，当我们需要时调用，函数体内会遍历技能信息的数据资产中的技能信息数组，找到合格的技能，然后学习（在服务器），并同步给客户端UI


------

### ASC上创建函数，需要传入一个等级根据传入的等级来设置技能状态

  - 命名为，`UpdateAbilityStatuses`
>![img](https://api2.mubu.com/v3/document_image/25165450_6d74d65d-1774-456c-e1ef-f96d40a40aea.png)
>![img](https://api2.mubu.com/v3/document_image/2fe5a303-63f1-49fb-bf9e-c843919da445-25165450.jpg)


------

#### 在遍历中，考虑一个情况：如果我们找到了一个技能（比如火球）该技能已经被学习了，但是我们怎么知道找到的技能是否已被学习呢？

  - 如果我们能够检查一下我们是否已经具备了这种游戏能力，那就太好了

  - 所以需要创建一个函数，根据技能规范，查找是否已学习，如果未学习，就可以学习了，如果学习了就返回已学习，这样就不用重复学习了


------

#### 创建一个根据 `AbilityTag` 查找指定 `FGameplayAbilitySpec` 的函数
>![img](https://api2.mubu.com/v3/document_image/25165450_772643bd-675e-47e6-9b88-5a429b0e3790.png)

- 如果没找到就返回空指针，这样就可以判断


------

##### 当遍历时，技能可能会随时被取消和移除，所以需要一个**技能列表锁** `FScopedAbilityListLock`


------

##### 遍历ASC的激活技能数组，然后遍历每个激活技能的AbilityTag，如果包含 `实参的标签` 就返回
>![img](https://api2.mubu.com/v3/document_image/25165450_b97ce3cc-7c8d-483e-916f-afa5ff9d3a1e.png)


------

#### 遍历数据资产中的技能，如果该技能未返回 `nullptr` 说明已学习该技能，如果返回 `nullptr` 说明未学习该技能，需要检查技能条件判断是否满足等级，若满足就学习
>![img](https://api2.mubu.com/v3/document_image/f4c40f09-bf3e-463b-8e5c-59b7bd0e9037-25165450.jpg)


------

## 但是有一个问题，当我们1修改了技能，然后更改了该能力的某些内容，有可能不会马上更新同步到客户端，那么需要调用API 强制更新，这样可以立即复制该GA_Spec到客户端，不用等到下一轮同步周期

  - 使用API：`MarkAbilitySpecDirty(传入该GA的Spec);`
>![img](https://api2.mubu.com/v3/document_image/25165450_4fd0270a-da86-4a27-fba8-c6d3f73a6f40.png)


------

### 接下来需要向客户端的UI中创建委托更新视觉表现，下一节


------

### 下一节


------

### 上一节我们创建了ASC在服务器上更新技能状态的函数，但是还没有地方调用，我们需要在升级时调用
>![img](https://api2.mubu.com/v3/document_image/25165450_c6ba679a-f5f1-4f78-f8b8-f3d90018f250.png)

- 在玩家基类中调用升级的函数时，可以处理这些逻辑
>![img](https://api2.mubu.com/v3/document_image/25165450_dfdbfef1-d0c9-4418-893d-e6052cd06ffd.png)


------

### 在玩家基类中，升级时（这里的逻辑数据处理是在服务器执行的），调用ASC的服务器逻辑 `UpdateAbilityStatuses`
>![img](https://api2.mubu.com/v3/document_image/25165450_49223a61-e9e1-4652-fc81-8fab4e1b34cd.png)


------

### 接下来需要往UI中同步消息


------

#### 接下来在ASC中创建包含两个参数的多播，不用在蓝图中使用，所以不用动态的

  - 两个参数分别为：

    - 技能Tag `AbilityTag`

    - 状态Tag `StatusTag`
>![img](https://api2.mubu.com/v3/document_image/25165450_bc0979e5-8c37-4164-e773-af458de48fbe.png)


------

##### 声明一个委托实例
>![img](https://api2.mubu.com/v3/document_image/25165450_8086d21c-eab8-49cd-b01c-bc53d83518c5.png)


------

#### 现在需要在客户端和服务器同步消息，所以需要创建RPC函数

  - 命名为，`ClientUpdateAbilityStatus`
  - `RPC_Client` 函数中广播
>![img](https://api2.mubu.com/v3/document_image/25165450_5e61a2b6-2250-46d0-8330-4ea64ca891ab.png)
>
>![img](https://api2.mubu.com/v3/document_image/25165450_09aff4dc-f1b9-4ec9-d672-d4c61877c374.png)


------

#### 当ASC更新技能状态后，调用 `RPC_Client` 函数
>![img](https://api2.mubu.com/v3/document_image/25165450_d52382a6-f6c4-44be-c652-e6c4fac9780c.png)


------

#### 接下来在 `SpellMenuWidgetController` 中绑定ASC的 `委托AbilityStatusChanged` 的回调

  - 这样会在初始化时绑定 `AbilityStatusChanged` 的回调，每当升级时，玩家基类调用ASC的`UpdateAbilityStatuses` 函数（在服务器）然后触发 `RPC_Client` 函数 `ClientUpdateAbilityStatus` 函数体内，广播触发在 `SpellMenuWidgetController` 中的委托 `AbilityStatusChanged` 回调


------

### 此时升级我们应该可以看到，技能树中新的技能被解锁
>![img](https://api2.mubu.com/v3/document_image/25165450_b504efb9-7e3f-4ad2-9cf0-63f690f463a2.png)

- 可是并没有解锁


------

### 我们断点ASC中的更新函数，看看Level数据是否有问题
>![img](https://api2.mubu.com/v3/document_image/25165450_8d8bd2fc-687f-4e8d-ab0f-c3d7f942002f.png)

- 升级时传入的等级好像不对
>![img](https://api2.mubu.com/v3/document_image/25165450_f4803fd1-c20f-4144-e423-b5d948d39c19.png)


------

#### 修改传入的等级
>![img](https://api2.mubu.com/v3/document_image/25165450_ab671a78-7dbb-4766-d557-1c835fa1e02e.png)


------

### 运行时测试gif，升级后修改可以解锁的技能球状态
>![img](https://api2.mubu.com/v3/document_image/25165450_e2800c8d-4037-4f78-89b8-ed21f2c95723.png)


------

#### LS模式下测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_e2800c8d-4037-4f78-89b8-ed21f2c95723.png)


------

#### DS模式下测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_e2800c8d-4037-4f78-89b8-ed21f2c95723.png)


------

### 接下来测试，打开UI的情况下，升级，是否会同步修改状态

  - 需要暂时修改之前的“打开UI时无法移动的逻辑”

  - 测试完记得改回来！


------

#### LS模式下测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_e2800c8d-4037-4f78-89b8-ed21f2c95723.png)


------

#### DS模式下测试gif
>![img](https://api2.mubu.com/v3/document_image/25165450_e2800c8d-4037-4f78-89b8-ed21f2c95723.png)


------

### 接下来我们将处理，技能点，并应用技能点解锁的逻辑，请看下集


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
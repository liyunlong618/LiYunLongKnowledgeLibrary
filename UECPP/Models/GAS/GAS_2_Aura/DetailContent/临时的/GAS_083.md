<details>
<summary>过程截图</summary>

>

------

</details>




+ `头文件`中：
```cpp
这里是头文件代码这里是头文件代码这里是头文件代码这里是头文件代码这里是头文件代码这里是头文件代码
```

+ `源文件`中：
```cpp
这里是源文件代码这里是源文件代码这里是源文件代码这里是源文件代码这里是源文件代码这里是源文件代码
```

[Mermaid格式参考](https://github.com/liyunlong618/LiYunLongKnowledgeLibrary/blob/main/Mermaid%E6%A0%BC%E5%BC%8F%E5%8F%82%E8%80%83.md)

[预览](https://github.com/liyunlong618/LiYunLongKnowledgeLibrary/tree/main/UECPP/Models/GAS/GAS_2_Aura)



___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 083 使用EQS环境查询 整个流程

___________________________________________________________________________________________

## 处理关键点

1. 111111111111111111111111111111
2. 222222222222222222222222222
3. 33333333333333333333333333
4. 4444444444444444444444444444
5. 555555555555555555555555555555
6. 666666666666666666666666666

- EQS使用步骤

  1. 创建EQS

  2. 创建特殊的Pawn类
       - EQSTestingPawn
  

  3. 创建新的测试地图

  4. 将自建EQSTestingPawn拖入场景，并配置对应的EQS

  5. 打开EQS并设置节点和需要的Test

       - 1.添加节点：点 路径网络 —— Points: Pathing Grid

  
       - 2.右键节点，添加Test -> Trace 跟踪
  

       - 可以创建自建的Context，也就是目标收集用的

  
       - 想制作的效果是敌人会找离我们尽可能近的点，然后能攻击到的视野不被遮挡的点
  

  6. 在行为树上使用EQS
  
       - 行为树直接调用EQS节点，并配置要使用的EQS
  
  
       - 在运行查询后，它将设置我们指定的黑板键之一
  

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[11. Environment Queries](https://www.bilibili.com/video/BV1JD421E7yC/?p=171&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[12. EQS Tests](https://www.bilibili.com/video/BV1JD421E7yC?p=172&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[13. Distance Test](https://www.bilibili.com/video/BV1JD421E7yC?p=173&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[14. Using EQS Queries in Behavior Tree](https://www.bilibili.com/video/BV1JD421E7yC?p=174&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 在这之前先整理一下文件

> - #### 创建四个文件夹
>
>   - #### `BehaviorTree`
>
>   - #### `Tasks`
>
>   - #### `Sercives` 
>
>   - #### `AlController`
>
> #### 现在有这些文件![img](https://api2.mubu.com/v3/document_image/25165450_d672cc1e-0cdf-45c7-94ae-94218a5a3ea1.png)
>
> #### 整理成这样的结构
>
> ![img](https://api2.mubu.com/v3/document_image/25165450_f2432d30-2f46-4ce1-ea91-707259efbcfc.png)![img](https://api2.mubu.com/v3/document_image/25165450_cbc22f33-e74a-4566-e545-c564f2935df1.png)

------

### EQS使用步骤

> 1. ### 创建EQS
>
> 2. ### 创建特殊的Pawn类
>
>    - EQSTestingPawn
>
>
> 3. ### 创建新的测试地图
>
> 4. ### 将自建EQSTestingPawn拖入场景，并配置对应的EQS
>
> 5. ### 打开EQS并设置节点和需要的Test
>
>      - 1.添加节点：点 路径网络 —— Points: Pathing Grid
>
>      - 2.右键节点，添加Test -> Trace 跟踪
>
>      - 可以创建自建的Context，也就是目标收集用的
>
>      - 想制作的效果是敌人会找离我们尽可能近的点，然后能攻击到的视野不被遮挡的点
>
> 6. ### 在行为树上使用EQS
>
>      - 行为树直接调用EQS节点，并配置要使用的EQS
>
>      - 在运行查询后，它将设置我们指定的黑板键之一

------

### 创建EQS

> - #### 在 `Aura/Public/AI/` 文件夹下
>
> - #### 命名为 `EQ_FindRangedAttackPosition`
>
> ![img](https://api2.mubu.com/v3/document_image/25165450_205b2e60-ea63-4bbc-c410-0920050dad44.png)

------

### 第二步：创建EQS需要的特殊Pawn，类型是： EQSTestingPawn

> - ### 存在一种`特殊类型的Pawn`，我们可以 `使用它来测试我们的环境查询`。
>
>   ##### 我们可以通过为我们生成的所有项目绘制一堆调试形状来测试他们正在做什么。
>
> - #### 命名为 `BP_EQSTestingPawn`
>
>
> ![img](https://api2.mubu.com/v3/document_image/25165450_4d5d06a6-9f6f-4f5e-b16f-5f84e9133e18.png)

------

### 第三步：创建新的测试地图

> - #### 在 `Content/Maps/` 下创建新的测试地图![img](https://api2.mubu.com/v3/document_image/25165450_0508e633-0638-4560-8227-8b736032f6db.png)

------

### 第四步：将自建EQSTestingPawn拖入场景，并配置对应的EQS

> ![img](https://api2.mubu.com/v3/document_image/25165450_776eb05e-9f67-476c-9091-a0a44994d17c.png)![img](https://api2.mubu.com/v3/document_image/25165450_8ac1260c-71f5-49b0-9356-2ae142489575.png)

------

### 第五步：打开EQS并设置节点和需要的Test

1. #### 添加节点

> <details>
> <summary>了解用 </summary>
>
> >
> >
> >- #### 这里以添加：点 路径网络 —— `Points: Pathing Grid` 为例
> > - #### 可以围绕一个查询点，生成点网格
> >
> >
> >![img](https://api2.mubu.com/v3/document_image/25165450_a7f96aa6-4d1d-488d-fd25-71265132cb46.png)
> >
> >- #### 查询点指的是
> >
> > - #### 当我们打开上下文，会发现有一个默认的 `EnvQueryContext_Querier`
> >
> > - #### 默认情况下，这通常是 `运行此环境查询的Pawn`。
> >
> >- ![img](https://api2.mubu.com/v3/document_image/25165450_5361ecad-95da-4ce8-a461-ff0f536021ca.png)
> >
> >- ![img](https://api2.mubu.com/v3/document_image/25165450_0cb901a8-54e4-4fbb-8337-8df69f5cc2ba.png)
> >
> >- ![img](https://api2.mubu.com/v3/document_image/25165450_d9a57509-b17f-4baf-e575-604b69cffac2.png)
> >
> >- #### 圆形的![img](https://api2.mubu.com/v3/document_image/25165450_07456ec5-7c0c-488b-ea8e-85982e3a5434.png)
>
> ------
>
> </details>
>
> 
>
>   - #### 添加：点 路径网络 —— `Points: Pathing Grid`
>
>   - #### 作用：可以围绕一个查询点，生成点网格

2. #### 右键节点，添加 `Test`

> - #### 添加 Trace 跟踪
>
>   - #### `Test Purpose` 使用：`过滤` —— `Filter Only`
>
>   - #### `Context` 使用默认还是自建的有待确认
>
>
> <details>
> <summary>了解用</summary>
>
> >- 这里以添加 Trace 跟踪 为例
> >
> > - Test Purpose 这里是对每个点的处理方式
> >
> >   - `得分` —— `Score Only`
> >
> >   - `过滤` —— `Filter Only`
> >
> >   - `得分且过滤` —— `Filter and Score`
> >
> >- 我们选择它，默认情况下它会根据可见性通道进行追踪。
> >
> >- 可以在测试详细信息面板中 `Context` ，我们可以从 `Context` 追踪到每个给定点
> >
> > - 事实上，上下文是一个类，我们可以创建并确定我们要跟踪的内容
> >
> >-  `Context` 默认值为 `EnvQueryContext_Querier` 这意味着我们将 `Trace` ，`可见通道`  `Visibility查询` 。而测试地图并没有什么障碍物
> >
> > - 当我们没有可以跟踪和命中的上下文时，跟踪并没有多大意义，
> >
> >![img](https://api2.mubu.com/v3/document_image/25165450_d8ba0616-1eea-4f66-fdfb-830e93326704.png)
> >
> >![img](https://api2.mubu.com/v3/document_image/25165450_d6c0ae4f-79d4-4290-e149-d77d7bc245ad.png)
>
> ------
>
> </details>

3. 可以创建自建的Context，也就是目标收集用的


<details>
<summary>创建自建的Context，目标收集用的</summary>

>### 因此，我们将创建一个环境查询 Context 并准确定义我们想要跟踪Trace的内容
>
>- 在 Content/Blueprints/AI/EQS/ 文件夹下
>
>- 创建 EnvQueryContext_BlueprintBase 类
>
>- 命名为 EQS_PlayerContext
>
>- 需要重写一个函数！！！(这几个挑一个重写就行)
>
> - Provide Actors Set
>   - 返回一个Actor数组
>
> - Provide Locations Set
>   - 返回一个Vector数组
>
> - Provide Single Actor
>   - 返回一个Actor
>
> - Provide Single Location
>   - 返回一个Vector
>
>- 这里使用的是Provide Actors Set返回Actors
> - 使用GetAllActorsOfClass获取BP_Aura_Charactor类对象
>
>- Bool Match
> - 表示是否要根据查询滤掉结果
>   - 假如都为蓝色也就是OK，取消勾选这个Bool Match，所有都变成红色，也就是，不OK了
>
>![img](https://api2.mubu.com/v3/document_image/25165450_2e24d704-bffa-4bf0-d663-87b70b84bef4.png)
>
>挑一个重写就行![img](https://api2.mubu.com/v3/document_image/25165450_f7906093-f11a-420d-bcb9-2c35a7d1210a.png)
>
>![img](https://api2.mubu.com/v3/document_image/25165450_dd6ea2df-9bf2-4d8e-93d4-3b2e665363e2.png)
>
>![img](https://api2.mubu.com/v3/document_image/25165450_fa611a5d-949e-45f2-e0a9-21fdfc492703.png)
>
>### 在 `Test` 的 `Trace` 上选择刚才自建的 `Context`
>
>![img](https://api2.mubu.com/v3/document_image/25165450_1a08550d-766d-481a-8678-bea4923f2a8b.png)
>
>#### 这个时候拖入玩家BP_Aura角色，发现所有的点都是蓝色，表示OK，因为时通过visibility通道查询，而且没有遮挡物
>
>![img](https://api2.mubu.com/v3/document_image/25165450_e59cbdec-fc0b-42d3-963a-889fd7e37b37.png)
>
>#### 此时我们拖入几何体发现，可以看到蓝色的是OK的过滤点，完全是躲着人走的感觉
>
>![img](https://api2.mubu.com/v3/document_image/25165450_e9913839-fdde-44c1-a6fb-f41c230965e1.png)
>
>- #### 躲着玩家和实现可以看到玩家的效果可以通过调节Test的Trace的参数Bool Match实现
>
>  - 在Test的Trace的参数Bool Match的影响
>
>     - Bool Match == true，视线总可以看到玩家![img](https://api2.mubu.com/v3/document_image/25165450_447b49b1-a89d-4d85-d165-0d24a05f6088.png)
>     - Bool Match == false，躲着玩家![img](https://api2.mubu.com/v3/document_image/25165450_926b7901-158d-4341-f285-c70effa7f775.png)
>
>### 有个问题：几何体内部也有红色的查询球体
>
>- #### 原因是：这个 StaticMesh 没有简单碰撞，只有复杂碰撞，且没有设置启用复杂碰撞
>
>![img](https://api2.mubu.com/v3/document_image/25165450_c71dde70-8f8c-4ed7-bf90-b74bf831ced3.png)
>
>#### 加上碰撞![img](https://api2.mubu.com/v3/document_image/25165450_d8b8fd6f-5737-4c58-e082-75974f5c4966.png)
>
>- #### 加入 `Nav Mesh Bounds Volume` ，这个是路径网格，路径与寻路有笑，而寻路与AI有关，所以路径网格不会给我们任何不可导航的点，所以这是需要注意的事情![img](https://api2.mubu.com/v3/document_image/25165450_eeaffddb-25dd-4bc5-bc27-b00b46c5dc68.png)
>
>
>
>### 接下来我们将创建一个 test 获得一个评分最高的地点
>
>
>
>### 添加一个新Test Distance
>
>- 允许我们计算从每个点到任一查询的距离
>
>- 结果颜色
>
>  - 红色0分 -> 绿色1分
>
>  - 使用 `归一化值` 表示
>
>- 当结果 `Scoring Factor == -1` 时结果为反向值
>
>  - 比如下图所示
>
>    - ### `Scoring Factor == -1`![img](https://api2.mubu.com/v3/document_image/25165450_69fdb32a-831d-4be6-a14c-1b7731429d3f.png)
>
>    - ### `Scoring Factor == 1`![img](https://api2.mubu.com/v3/document_image/25165450_e2080729-e424-45c2-df9e-5da517bcf5b7.png)
>
>- ### 若 `Context` 选择玩家，这里 玩家越远分数越高
>
>#### 为了测试方便我们这样设置![img](https://api2.mubu.com/v3/document_image/25165450_7bad4785-e62c-4c41-d99e-e3d63817f993.png)
>
>#### 距离指的是每一个点到Context的距离![img](https://api2.mubu.com/v3/document_image/25165450_0df0c89e-d45e-4881-e24d-a3e962c17690.png)
>
>![img](https://api2.mubu.com/v3/document_image/25165450_e2080729-e424-45c2-df9e-5da517bcf5b7.png)
>
>![img](https://api2.mubu.com/v3/document_image/25165450_70ff338a-a545-47fc-a2ed-e71ac9d286a2.png)
>
>![img](https://api2.mubu.com/v3/document_image/25165450_15d7cecd-4cc1-4eb0-845d-72650aa8b591.png)
>
>![img](https://api2.mubu.com/v3/document_image/25165450_15f25c9c-492f-44f3-bc44-fbdf8f15b0dd.png)
>
>

------

</details>

4. #### 添加一个新`Test Distance`

> - 设置为：
>   - 上图
>
> 

#### 5. 我们想制作的效果是敌人会找离我们尽可能近的点，然后能攻击到的视野不被遮挡的点

> - #### 所以使用![img](https://api2.mubu.com/v3/document_image/25165450_34f2cdc2-deb4-4d5d-947d-c7de8b87555b.png)
>
> - ![img](https://api2.mubu.com/v3/document_image/25165450_a5083658-67aa-4133-811f-b09776034a8f.png)![img](https://api2.mubu.com/v3/document_image/25165450_88137ab9-b07c-4d3a-b828-b3cdc870c1b8.png)![img](https://api2.mubu.com/v3/document_image/25165450_df4d1148-b171-4012-afb2-ebc857d9fad6.png)

------

### 第六步：在行为树上使用EQS

> - #### 行为树直接调用EQS节点，并配置要使用的EQS
>
> - #### 在运行查询后，它将设置我们指定的黑板键之一
>
> ![img](https://api2.mubu.com/v3/document_image/25165450_9b2ef47a-9a09-4f2c-d6ca-a0798fafd537.png)

------

### 远程的行为树分支上流程为： EQS设置位置 -> MoveTo -> 攻击 -> Wait

> - 这里需要mermaid
>
> - ## EQS设置位置 -> MoveTo -> 攻击 -> Wait
>
> ![img](https://api2.mubu.com/v3/document_image/25165450_db0a2e5e-960f-4b54-8e72-068d05fdeb6b.png)

------

### 添加墙 `StaticMesh` 测试

> ![img](https://api2.mubu.com/v3/document_image/25165450_f22181b8-d2df-44e1-8735-5d84e514f407.png)

### 这里有个bug：在墙附近，不小心点到墙面，崩溃了

> - #### 原因是之前获取NaviMesh导航的最后一个路径点使用的时Num()-1 当数组长度为0时，点击就会导致崩溃
>
> - #### 解决方法：使用前记得加 if 判断![img](https://api2.mubu.com/v3/document_image/25165450_3e6ada52-de49-4a1d-85e6-2615b12b1761.png)

### 测试结果gif

> ![img](https://api2.mubu.com/v3/document_image/25165450_f1d9deb8-588e-48b3-fdac-10ffcf7cd07e.png)


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
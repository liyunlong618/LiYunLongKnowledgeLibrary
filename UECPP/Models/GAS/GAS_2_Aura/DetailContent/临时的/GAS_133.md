___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 133 创建 `SpellMenu` 要使用的 `WidgetConttroller`；重构 `OverlayWidgetController` 中的逻辑到父类中

___________________________________________________________________________________________

## 处理关键点

1. 多次触发广播的框架结构

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[9. Spell Menu Widget Controller_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=76&spm_id_from=333.880.my_history.page.click&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 添加装备技能的按钮
>![img](https://api2.mubu.com/v3/document_image/25165450_2b2cd170-2f9c-4ea6-aa26-28165c646b0a.png)


------

### 创建 `SpellMenu` 要使用的 `WidgetConttroller` 继承自 `AuraWidgetController`

  - 命名为，`SpellMenuWidgetController`

  - 
>![img](https://api2.mubu.com/v3/document_image/25165450_a7b40784-07d0-47b0-cfa8-b367a23392d6.png)


------

### `SpellMenuWidgetController` 中需要重写父类中的两个自建虚函数，一个是绑定回调用 `BindCallbacksToDependencies` ，一个是广播用 `BroadcastInitialValues`
>![img](https://api2.mubu.com/v3/document_image/25165450_c42e8f96-18e3-461b-9266-208e34a78f4f.png)


------

#### 这两个函数在父类中没有写逻辑，所以可以删除 `Super` 调用
>![img](https://api2.mubu.com/v3/document_image/25165450_5b8b5dc0-4a3a-4c32-99b5-8bdb12e9a27f.png)


------

### 我们需要在UI初始化时广播我们拥有的技能

  - UI初始化时

    - 需要调用SetWidgetController，，

    - 然后绑定回调

    - 最后调用 `BroadcastInitialValues` 广播 `技能结构体` 数据


------

#### 我们先看一下之前在 `OverlayWidgetController` 中初始化技能图标的逻辑
>![img](https://api2.mubu.com/v3/document_image/25165450_9ac5fdad-9a0b-4e0e-d0eb-bbc648e7fc93.png)

- 通过循环广播，多次触发这个 `lambda` 从而广播激活的技能数据到UI
>![img](https://api2.mubu.com/v3/document_image/25165450_0f9ebb13-3c5b-4f12-9b2d-bd36a930f2bd.png)


------

#### 我们可以将这个 `初始化函数` 里面的逻辑挪到父类 `AuraWidgetController` 中

  - 所以委托也需要移动到父类中
>![img](https://api2.mubu.com/v3/document_image/25165450_c16020de-e074-444f-b4ed-9c4b5076da97.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_c998f1ba-2341-44eb-e226-dd61ba63f261.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_cf578100-0875-404b-c405-7084aae01725.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_c7fb9c04-a363-4bc1-de23-30adb3ab7a82.png)


------

### 下面需要重构逻辑


------

### 有个问题是，这个初始化函数依赖于 `AuraASC组件` 中创建的函数，所以父类上必须有 `AuraASC组件`

  - 既然父类需要拥有ASC的子类，而ASC又是WidgetController中需要保存的四大数据之一，那就把四大数据全部子类化保存在父类上

    - 也就是，再保存四个子类的指针

      - `AuraASC`

      - `AuraAS`

      - `AuraPC`

      - `AuraPS`


------

### 下面在父类中保存四大数据的子类指针，和Get四大数据子类的函数
>![img](https://api2.mubu.com/v3/document_image/25165450_62dbcd35-033c-4df5-e6ad-e46bf5a69bde.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_692239f0-c8d1-4c12-ee9b-e5c5f3cd4973.png)


------

### 此时编译会报错，需要使用父类中的 `获取四大数据子类方法` 替换原来的 `Cast子类` 的逻辑（涉及到的地方，都需要处理）
>![img](https://api2.mubu.com/v3/document_image/25165450_db13ca8b-8db2-4ae1-92dc-de2a158ee930.png)


------

### 父类中，准备迁移初始化广播技能信息的函数，新建函数，命名为，`BroadcastAbilityInfo`
>![img](https://api2.mubu.com/v3/document_image/25165450_4a6653bd-1825-467b-fcab-0b562dde960d.png)

- 迁移逻辑后，包含技能结构体的数据资产报错

  - 
>![img](https://api2.mubu.com/v3/document_image/25165450_b7b71a6b-f5a2-4f62-bbc2-e8a7e9378e3e.png)

  - 因为数据资产是在 `OverlayWidgetController` 上配置的，所以也需要迁移到父类中
>![img](https://api2.mubu.com/v3/document_image/25165450_829ccd4d-ec10-40cd-f1fa-16fd2b527795.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_b4767e3f-3e85-4240-836f-5ac478c12daa.png)


------

### 需要在原来调用子类函数的时候，改成调用父类的 `BroadcastAbilityInfo` 函数，绑定的回调也需要处理
>![img](https://api2.mubu.com/v3/document_image/25165450_8be32ae9-d5e2-4f5f-c30a-c14f092a3504.png)


------

#### 绑定的回调也需要处理
>![img](https://api2.mubu.com/v3/document_image/25165450_801d4b76-8043-48cf-e99c-f1278942f107.png)


------

##### 但如果处理绑定的回调，创建的多播就需要改成不能传递参数（反正传递的也是AuraASC，父类上有获取方法）
>![img](https://api2.mubu.com/v3/document_image/25165450_55c55832-e405-4c2b-cdff-eed1ddb69820.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_58e66e13-db87-4c01-e54d-752fba1baadf.png)


------

##### 需要在ASC组件上广播时，也修改传递的参数
>![img](https://api2.mubu.com/v3/document_image/25165450_416220e8-45fe-472e-c280-1930ae155ae5.png)


------

##### 这样就可以绑定回调为 `BroadcastAbilityInfo` 了
>![img](https://api2.mubu.com/v3/document_image/25165450_d084cc8a-1638-4fac-9fba-f6367190e392.png)


------

#### 然后删除子类的函数，因为可以直接使用父类函数
>![img](https://api2.mubu.com/v3/document_image/25165450_0bfce21d-d13d-47c9-912e-a58a2e827050.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_1aa3df5f-f3ff-49a1-91cc-096525bb84b9.png)


------

### 上面这样就完成了重构逻辑


------

### 接下来运行测试gif，重构逻辑后，应该和之前的一样，没有异常
>![img](https://api2.mubu.com/v3/document_image/25165450_e302bd03-1136-4af8-d11e-510e516fd3b6.png)


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
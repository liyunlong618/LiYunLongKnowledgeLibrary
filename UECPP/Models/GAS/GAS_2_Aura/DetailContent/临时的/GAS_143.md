___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 143 C++中 使用 `Printf` 格式化字符串输出到富文本；每个GA中都需要一个返回自身技能描述的虚函数；GA中拿到CD和技能消耗的方法

___________________________________________________________________________________________

# 目录


[TOC]

___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[24. Spell Descriptions_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP?p=91&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[25. FireBolt Description_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=92&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

[26. Cost and Cooldown in Spell Description_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=93&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

- 


------

### 如果使用富文本描述技能相关属性，这里想让描述成为技能本身的属性，也就是在GA基类上创建获取的函数，因为像 `技能CD` 和 `技能消耗` 这种 `GE` ，只有 `通过GA` 才可以 `拿到`


------

### 在 `GA基类` 中，创建函数

  - `GetDescription`
    - 当前等级技能详情

  - `GetNextLevelDescription`
    - 下一级描述

  - `GetLockedDescription`

    - 如果技能是锁定的可以调用这个函数

    - 提示，技能待解锁等级

  - 传入当前等级，返回 格式化的字符串

>![img](https://api2.mubu.com/v3/document_image/25165450_f58d2ffa-887b-4f3e-a065-b537c929d127.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_5d470e39-60ea-4358-c238-64017349c92f.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_aeb85b50-04ce-457b-95d0-0b4699d5cb42.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_9a158279-faec-4806-ca69-3d8112c1e9c9.png)


------

#### 如果我使用带引号的大写 `L"这里是内容"`，这将为我创建一个宽字符,


------

#### `Printf` 中使用 `\n` 换行


------

#### 锁定的技能会返回一串文本，提示 `解锁` 该技能需要的 `等级`

>![img](https://api2.mubu.com/v3/document_image/25165450_728f9889-57fd-48b2-84ba-fd428b250c73.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_4e783d17-809d-4ca1-c46d-7ac2443bff75.png)

- 设为静态的含义是，这样可以在别处很方便地调用获取字符串


------

### 我们在使用时，肯定是通过 `ASC组件` 根据当前技能的 `AbilityTag` 来返回当前技能的描述，所以需要在 `ASC` 中创建相应的函数


------

#### 创建函数，根据当前 `AbilityTag` 返回技能的当前等级和下一级描述的格式化文本 `FString` ，返回值为 `bool`

  - 函数命名为，`GetDescriptionsByAbilityTag`

  - **若成功返回 `true` ，失败返回 `false` ，返回值以引用的方式传递**

  - **调用函数 `GetSpecFromAbilityTag` ，如果返回不为空，说明学习了相关技能，可以 `通过GA_Spec拿到Level` 传值，然后调用获取当前和下一级技能描述然后返回 `true` ；如果返回为空，则通过蓝图函数库拿到 `GM` 中的 `AbilityInfo` ，然后获取该技能所需的解锁等级，传入 `待解锁等级`**

>![img](https://api2.mubu.com/v3/document_image/25165450_c8a5b3b8-b784-46e3-99c6-58b04acdd049.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_b36faad6-0221-4708-e269-b6eb7c17fb7c.png)


------

### 当我们每一次选择技能时，看一下之前的逻辑

  - 我们广播了两个相关按钮的最新状态更新，其实，选择技能球后，也需要广播当前技能的这一级和下一级的描述

>![img](https://api2.mubu.com/v3/document_image/25165450_8587c95f-f614-4515-dd18-e745058c867b.png)


------

#### 所以修改动态多播，除了广播两个bool之外，添加两个变量，是富文本块所需的FString

  - `DescriptionString`

  - `NextLevelDescriptionString`

  - **如果修改，之前的广播，都需要修改**

>![img](https://api2.mubu.com/v3/document_image/25165450_5007a94b-894e-4ec0-cf4e-1e8b6406b79e.png)

- **广播都需要修改，添加参数**

>![img](https://api2.mubu.com/v3/document_image/25165450_4518bb35-e26b-40ff-f528-09d0c97d332b.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_576019ba-d533-421e-80fe-70c7af583f8e.png)


------

#### 蓝图中现在多了两个参数，设置富文本Text

>![img](https://api2.mubu.com/v3/document_image/25165450_b107ed86-f8bf-48e5-ba40-48444d7cc08e.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_8330113f-ae4c-44d1-9a14-c55b52a754f1.png)


------

### 此时运行游戏，发现有问题

>![img](https://api2.mubu.com/v3/document_image/25165450_f83004dc-e977-4e17-e1f6-b499deab3779.png)

- 富文本超出了最长的限制，多出的部分也没有被显示


------

### 启用富文本的自动换行，选中后会执行换行

>![img](https://api2.mubu.com/v3/document_image/25165450_185da802-8a3d-4031-9599-72fdf827e359.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_fa08b135-94be-4356-8cc7-e870a260d445.png)


------

### 运行测试，当我们 `1级` 时，选中 闪电技能 ，会提示它在 `2级` 解锁

>![img](https://api2.mubu.com/v3/document_image/25165450_af61abdf-3e0f-4967-f5bd-fe2d93df3557.png)


------

### 我们现在的描述有了，但是比较简单，下面将显示更多的信息，下一节


------

### 下一节


------

### 希望显示更多的信息，比如：

  - 当前等级描述：

    - 技能：火球

    - 发射1枚火球

    - 有一定几率造成9点燃烧伤害

    - 等级：1级

  - 下一级描述：

    - 技能：火球

    - 发射2枚火球

    - 有一定几率造成17点燃烧伤害

    - 等级：2级

>![img](https://api2.mubu.com/v3/document_image/25165450_d1dcf842-a110-487c-9610-a6f32ef24de2.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_bc7b344c-a73d-4426-82c4-b99a0d240002.png)


------

### 小测试，实现上述更多信息的效果描述

>![img](https://api2.mubu.com/v3/document_image/25165450_d00f12fc-bf9d-4e74-a7ef-1c71e304a779.png)


------

### 自己尝试一下

  - 通过GA拿伤害的曲线，然后获取当前等级伤害和下一级伤害

  - 等级通过AbilityLevel获取

  - 格式化文本


------

#### 火球技能中重写描述的虚函数

>![img](https://api2.mubu.com/v3/document_image/25165450_7e2f052b-0966-442c-94a1-b7cb3d723363.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_cc55cf21-a730-44fc-b604-6e51ecff49a3.png)


------

#### 大致效果

>![img](https://api2.mubu.com/v3/document_image/25165450_5e4cd2e6-5fc0-4109-c805-3f30d92fb7d2.png)


------

### 下一节


------

### 在这一节中我们将显示更多的技能描述，比如 `CD` /和 `技能消耗`

>![img](https://api2.mubu.com/v3/document_image/25165450_488cd8a7-33c6-4f0f-862f-49aa547576a6.png)


------

### 想要搞一个 `AuraProjectileSpell` 的C++子类，作为火球术技能蓝图的父类，然后在类中重写火球术的描述，这部分逻辑可以更加格式化和抽象

  - **命名为，`AuraFireBolt`**

>![img](https://api2.mubu.com/v3/document_image/25165450_05675d82-494f-467f-ada0-3d132785ac1c.png)


------

#### 将父类 `AuraProjectileSpell` 的描述虚函数挪到 `AuraFireBolt` 中

>![img](https://api2.mubu.com/v3/document_image/25165450_091babf3-ba2d-42cc-93ce-26b1dc80c6e1.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_06439976-5673-4cad-c284-4a9a7c4fdae1.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_0855149d-52e6-472a-93d9-6d4407814cac.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_4d7621a2-0223-4d5e-bb18-24d2a8d6172d.png)


------

#### 修改蓝图 ***GA_FireBolt*** 父类

>![img](https://api2.mubu.com/v3/document_image/25165450_13ab0587-0925-4357-c741-5b85d78fb1f3.png)


------

### 接下来需要获取 `技能消耗` 和 `cd` 而这部分逻辑可能别的子类也会使用，所以写在基类 `AuraGameplayAbility` 中，const函数

>![img](https://api2.mubu.com/v3/document_image/25165450_5eab868a-8395-490b-d5ce-2ea2545d6fb0.png)


------

#### 关于如何在GA中获取技能消耗的GE?


------

##### 使用API：`GetCostGameplayEffect` 可以获取 `Cost` 的 `GE`


------

##### 拿到 `Cost` 的 `Modifiers` 


------

##### 遍历 `Modifiers` 里面保存着一些结构体，而结构体中，可以拿到设置的属性


------

##### 而 `ModifierMagnitude` 就是蓝图中的策略，比如：

  - 使用固定值

  - `SetByCaller`

  - 自定义计算方式

  - 这些


------

##### 通过 `结构体的ModifierMagnitude.GetStaticMagnitudeIfPossible`可以拿到固定值（只能拿到固定值，如果是别的设置方式，拿不到！）

>![img](https://api2.mubu.com/v3/document_image/25165450_f0e2a82b-d744-418e-f70d-778886c55f3f.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_90d24a57-b23c-468a-d585-8d4cbf0ce84f.png)


------

### 这里判断是否为1级是因为1级描述和别的等级不同


------

### 在 `Printf` 中使用 `%.1f` ，可以保留float小数点右边一位小数

>![img](https://api2.mubu.com/v3/document_image/25165450_7d44d313-32fc-4736-e8da-e2ef1a63d443.png)


------

### 可以使用这样的方式 让 `Printf` 里面的内容 更清晰

>![img](https://api2.mubu.com/v3/document_image/25165450_f7fbfd31-6a84-4cee-d395-fb1332474bc6.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_87475d0a-0269-4a8c-8252-52be4557033d.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_c5a2f429-0841-4a68-c840-567a7a3553af.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_756758cc-9c27-4c2e-e878-4589242e9a6e.png)


------

### 现在获取伤害Damage的逻辑有些多，希望能抽象成一个函数

>![img](https://api2.mubu.com/v3/document_image/25165450_7381d62a-85d2-4d46-d9ad-52aad6016034.png)


------

#### 创建函数，根据 `等级` 和 `伤害类型的Tag` 

  - 函数命名为，`GetDamageByDamageType`

>![img](https://api2.mubu.com/v3/document_image/25165450_aab95d68-5ad8-4305-e0a5-3510a5e74d0d.png)


------

##### 函数体内，进行断言检查，检查包含 **曲线表格和伤害Tag** 的 `TMap` 内是否包含指定“伤害Tag”。`防止忘记配置资产！`

>![img](https://api2.mubu.com/v3/document_image/25165450_b0e9e82c-72f5-46c1-c0db-e4b6c5458da5.png)


------

#### 在原位置调用

>![img](https://api2.mubu.com/v3/document_image/25165450_67b50c4e-6899-4b64-95c0-31acfdc02c78.png)


------

### 运行测试，检查 `UI` 显示的 `富文本`

>![img](https://api2.mubu.com/v3/document_image/25165450_a15819f5-cfbc-4f58-b5c8-bad38e8a9082.png)


------

### 消耗，是负值


------

#### 使用API：`FMath::Abs` 确保技能消耗为正值


------

### 注意一下结尾的符号不要用错了

>![img](https://api2.mubu.com/v3/document_image/25165450_a23e158f-de61-4ce3-cf02-ddb1e6bb1f89.png)


------

### 运行测试

>![img](https://api2.mubu.com/v3/document_image/25165450_448038a6-e45a-44e4-a853-3404ce7dc361.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_02fa995e-3a9e-417e-cee8-1ea69ffd861c.png)


------

### 如果有这种，需要加一点 `Padding` 偏移

>![img](https://api2.mubu.com/v3/document_image/25165450_94bce11b-052d-4ca0-cdac-20296686cca0.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_ed85cb00-0ad7-41d5-c636-2fc4e3f0f989.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_d4aed45a-3c4e-4851-dc9c-4e0bf7171aca.png)


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
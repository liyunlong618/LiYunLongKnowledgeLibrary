___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 174 制作眩晕debuff逻辑；处理技能之间的打断；处理DS模式下客户端的bug；需要注意tag不会复制！！！

___________________________________________________________________________________________

## 处理关键点

1. 角色动画模板中使用动画要使用 `SequencePlayer`
2. C++处理：GE中在持续时间内添加tag
3. 复习下：代码中设置黑板值
4. 复习下：属性复制和监听tag变化

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[20. Stun_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP?spm_id_from=333.788.player.switch&vd_source=9e1e64122d802b4f7ab37bd325a89e6c&p=133)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 这一节我们来处理，闪电技能的Debuff —— 眩晕


------

### 先处理一个bug：如果再释放火球技能之后（很短时间内）释放闪电技能，会打断火球技能


------

#### 可以使用技能打断标签，阻止再释放火球技能时，受到别的技能的影响比如图1（当然这样的设置有些广泛，可以单独配置技能Tag比如图2）
>![img](https://api2.mubu.com/v3/document_image/25165450_b0a04f1d-1265-4595-bd85-f93ba8219677.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_feb44e7b-81c0-4d2a-d825-9ed7a864264b.png)


------

#### 也可以单独配置一个打断技能的标签，让释放的不想被打断的技能拥有这个Tag


------

### 接下来我们来制作闪电技能Debuff
  - 当我们应用伤害时，想要应用最后一个伤害量的时候才检测Debuff


------

#### 我们之前是在 `Debuff` 函数中创建GE然后应用了GE，并根据参数配置
>![img](https://api2.mubu.com/v3/document_image/25165450_41112c29-5b63-4427-8138-c5e64aec1fe0.png)

>![img](https://api2.mubu.com/v3/document_image/25165450_17fd0548-4049-4168-a0f6-2b3cc43ffc90.png)


------

#### 可以在准备结束技能前，应用Debuff，先对主要目标造成Debuff伤害，然后遍历受到影响的目标，再对其应用Debuff伤害
>![img](https://api2.mubu.com/v3/document_image/25165450_ff4e25d9-761d-41ef-ec22-d19d57f9fcae.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_2c959831-9c07-4168-b4cc-fe296db33587.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_1dcd67ff-f94f-436f-d677-82822f7ba2fc.png)


------

##### 将Debuff触发概率设为100，击飞概率0，然后测试
>![img](https://api2.mubu.com/v3/document_image/25165450_450ee349-cf99-49ef-88b5-1d05291d49e3.png)


------

##### 运行游戏发现敌人还是被击飞了，需要看下哪里设置了击飞


------

###### 之前我们在这里只是检查击退力的大小，并没有使用到概率，所以，需要设置击退力为0，才能生效
>![img](https://api2.mubu.com/v3/document_image/25165450_627eef86-2ee2-4920-c03f-0418b3bb228a.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_b73d2b35-759e-4431-ab2c-92e28a70ad3a.png)


------

##### 运行测试：攻击敌人后，敌人debuff状态会触发受击技能
>![img](https://api2.mubu.com/v3/document_image/25165450_fd469c64-3c25-463d-d07c-f1efbf90b508.png)


------

#### 想要在闪电技能debuff的持续期间内眩晕敌人，而不是受到伤害

- 所以需要把debuff伤害设置为0
>![img](https://api2.mubu.com/v3/document_image/25165450_c4db02d9-1cb8-4940-9299-f7c4b91109e1.png)


------

#### 除此之外，受到debuff影响的敌人还应该无法移动，且，显示动画


------

##### 眩晕打算使用状态机来做
  - 需要在角色基类上创建一个变量，因为玩家和敌人都可以眩晕


------

###### 角色基类上创建眩晕的变量（需要开启属性复制！）

  - `bIsStunned`

>![img](https://api2.mubu.com/v3/document_image/25165450_02cd8c73-f132-440a-916e-38e015e72475.png)

  - 配置属性复制
>![img](https://api2.mubu.com/v3/document_image/25165450_17ee4b4f-0b33-4c27-a12e-5700cd13d1d2.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_89f86cbc-faaa-48f2-f1c7-f9b6e6619b28.png)


------

##### 角色基类上还需要监听Tag标签的变化（创建回调函数）

  - `StunTagChanged`

  - protected：
>![img](https://api2.mubu.com/v3/document_image/25165450_cfd1ed7a-efbd-4d4e-f567-76e63c25ee69.png)


------

###### 关于绑定的时机：可以在角色基类的函数中处理，这样子类只需要在初始化完成后调用Super即可
>![img](https://api2.mubu.com/v3/document_image/25165450_c773de69-50dc-480f-a2ba-97797245cb84.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_fc4c4a3e-0d62-45ee-edcf-defaf9db7407.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_4a226f9a-3365-42f7-fdf2-c09478104345.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_5443f732-3afb-4cdf-fd8a-c29f24a04215.png)


------

###### 因为我们在子类上分别绑定了各自的函数，所以回调函数可以写成虚函数，这样可以让子类可以重写不同的逻辑
>![img](https://api2.mubu.com/v3/document_image/25165450_adc0f98d-46f3-44c8-b02f-9474b0f1ddc4.png)


------

##### 根据Tag计数不同执行不同策略
>![img](https://api2.mubu.com/v3/document_image/25165450_4feada44-0f14-420c-c5f4-2013387edf31.png)

- 但是这个变量我们之前是在敌人中创建的，需要挪到角色基类中
>![img](https://api2.mubu.com/v3/document_image/25165450_510a6d50-34cc-4328-930a-09436aabc2ee.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_1632a710-f752-4a47-8d92-17418af279d2.png)

- 修改默认值为600.f，敌人的可以单独设置
>![img](https://api2.mubu.com/v3/document_image/25165450_57e737e5-a9d7-4f3f-f2ff-b4ba101b7453.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_eac717cc-7b29-451a-cd6b-c3a4dc793158.png)

- 然后就可以使用了
>![img](https://api2.mubu.com/v3/document_image/25165450_dd8a3613-c435-45fe-fce9-768aca5c3d74.png)


------

##### 敌人ABP初始化时记录指针，Tick中设置
>![img](https://api2.mubu.com/v3/document_image/25165450_f5f831f9-e289-4590-9a71-eff75c8f01f1.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_efd24117-e3b3-4bfc-c1da-884d5125a735.png)


------

##### 状态机中，设置过度和动画
>![img](https://api2.mubu.com/v3/document_image/25165450_400c6f8d-6162-4445-8ddc-a36749451d3c.png)


------

###### 敌人眩晕动画，因为要设置的是动画模板的动画，所以需要使用 `SequencePlayer`
>![img](https://api2.mubu.com/v3/document_image/25165450_a0f8d3a8-ec9e-4f2a-f5ce-476476182b35.png)

- 配置动画
>![img](https://api2.mubu.com/v3/document_image/25165450_3066f572-7a9d-4558-d415-8882ddc31066.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_bbd5d9cb-749c-42af-aa3e-b888125398d6.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_8a29551d-a6db-4395-8a46-8782e030b3d4.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_880eb982-ff60-4f92-80b6-487a3217ebe5.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_bc0c4fa8-fd85-4c60-b494-d1db332dfc2a.png)


------

###### 玩家眩晕动画也需要设置
>![img](https://api2.mubu.com/v3/document_image/25165450_f26d532a-2d58-4e01-d8b4-38501e394132.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_759b6360-4814-4a41-a24b-b89d61300c81.png)


------

#### 运行测试gif：敌人先进入受击状态播放完蒙太奇后，才开始眩晕
>![img](https://api2.mubu.com/v3/document_image/25165450_e20e60f5-249c-4921-b5f7-cc0c5ed3dc5b.png)


------

#### 我们之前在行为树中处理了，受击打断的逻辑，也需要搞一个眩晕状态的黑板键
>![img](https://api2.mubu.com/v3/document_image/25165450_75fefe9b-5c28-4a4d-f248-49e6b3e843a3.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_f076e6b2-4d2c-40e6-f489-dd4e4917bc94.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_06009c09-c88a-416e-ded9-a810562ffaea.png)


------

#### 现在敌人基类中，需要额外设置黑板键，所以需要重写回调函数
>![img](https://api2.mubu.com/v3/document_image/25165450_e5aeb95f-1129-4938-aa2d-8723179d48c8.png)

- 注意下黑板键不要写错了!
>![img](https://api2.mubu.com/v3/document_image/25165450_b04e8c64-59ba-48ba-fd1a-742e69ef8eb8.png)


------

#### 运行测试gif：敌人受到攻击进入眩晕状态5秒后，恢复
>![img](https://api2.mubu.com/v3/document_image/25165450_b7ec4efb-7b6c-409b-9623-bec20694c3cc.png)

- 5s是因为Debuff持续时间是5s


------

#### 因为，敌人萨满单独创建了行为树，也需要设置
>![img](https://api2.mubu.com/v3/document_image/25165450_dba01d1c-26b0-4d5c-cdbd-f165ada841d9.png)


------

### 接下来，我们需要让敌人使用闪电类型的攻击，并让他百分百触发Debuff测试玩家眩晕状态


------

#### 我们将敌人的伤害类型改为闪电伤害，在修改debuff触发概率
>![img](https://api2.mubu.com/v3/document_image/25165450_ced12084-d5ef-4544-aa09-778be1b18077.png)


------

#### 运行测试gif：让敌人攻击玩家
>![img](https://api2.mubu.com/v3/document_image/25165450_b76ae291-d8ae-4bd2-cdfe-91bd308faad0.png)

- 可以旋转，但是玩家眩晕期间无法移动


------

##### 现在玩家眩晕期间可以施法


------

###### 在技能上添加被指定标签（比如眩晕）阻挡
>![img](https://api2.mubu.com/v3/document_image/25165450_3994e17f-338e-4e0b-92f8-76049aafd301.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_4bdf17f2-bb60-42d2-98c0-011af4c6b752.png)


------

##### 接下来处理眩晕期间禁止移动和旋转


------

##### 我们现在需要在应用Debuff的GE 时，也让目标ASC携带Debuff的标签，在结束后移除


------

###### 之前是在GA中设置 技能激活期间 带有 `阻挡按键Tag` 
>![img](https://api2.mubu.com/v3/document_image/25165450_e9769ab1-8957-4fd3-ef13-4d720149c37c.png)

- 然后触发按键时检查
>![img](https://api2.mubu.com/v3/document_image/25165450_63a2e44b-609e-4b6d-a5ba-5a2ffcd6fddf.png)


------

###### 我们也给GE添加过Tag
>![img](https://api2.mubu.com/v3/document_image/25165450_eecaa230-2bfb-46a4-f117-3a53e2f08ce4.png)


------

###### 需要让Debuff持续时间内也持有对应Debuff的Tag，并在眩晕期间（闪电Debuff期间）禁用所有按键输入（也就是持有所有按键阻挡Tag）
>![img](https://api2.mubu.com/v3/document_image/25165450_dc690f7f-c190-4f72-e445-7ee199ed9b42.png)


------

###### 运行测试gif：现在眩晕后无法移动旋转了
>![img](https://api2.mubu.com/v3/document_image/25165450_74932056-2e77-45b2-bf6f-e6219b1acaae.png)


------

### 多人DS模式下测试


------

#### 服务器可以禁止移动，客户端没有禁止移动
>![img](https://api2.mubu.com/v3/document_image/25165450_b8b9c08e-ed91-45f0-df52-0add8f21fb8a.png)

- 说明Tag并不会复制


------

#### 可以使用之前创建的眩晕状态的bool，使用属性复制来制作逻辑
>![img](https://api2.mubu.com/v3/document_image/25165450_069bd6e5-24bf-4e20-a551-24270967c9f9.png)


------

##### 修改为属性复制通知，添加回调
>![img](https://api2.mubu.com/v3/document_image/25165450_7c5d04ae-3fb4-4817-8e33-cbbe510540a6.png)


------

##### 在属性修改的回调中，添加tag
>![img](https://api2.mubu.com/v3/document_image/25165450_3eb5255f-9843-452c-e360-6fb6e519c94e.png)


------

##### 通过bool判断是添加还是移除tag
>![img](https://api2.mubu.com/v3/document_image/25165450_296bee93-6422-4ba1-e7c9-8253f1d68996.png)


------

### 还有一个bug：DS模式下，当客户端使用闪电技能攻击敌人触发debuff后，再次攻击别的目标，不会取消之前的闪电技能链接NS，下一节处理
>![img](https://api2.mubu.com/v3/document_image/25165450_d6d3fcdc-5ab4-4351-9c43-b5924504c4ef.png)


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________
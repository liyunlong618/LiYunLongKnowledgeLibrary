___________________________________________________________________________________________
###### [Go主菜单](../MainMenu.md)
___________________________________________________________________________________________

# GAS 134 重构函数参数的思路方法！！！初始化和获取 `SpellMenuWidgetController`

___________________________________________________________________________________________

## 处理关键点

1. 梳理初始化技能广播技能信息的框架
2. 重构函数参数的思路方法！！！
   - 我们修改创建参数的函数，不要返回Param结构体，改成传进一个Param结构体的引用，这样可以在函数内部修改值，返回值改为bool，这样可以知道成功或者失败。而且这样做有一个好处是：如果返回结构体，则需要在头文件中引用结构体所在的头文件；但如果引用传参，只需前向声明结构体即可，减少项目冗余引用，提高运行效率
3. 使用蓝图反射宏：蓝图节点中的参数 **默认值 设置为 Self**
   -  `UFUNCTION(meta = (DefaultToSelf = "WorldContextObiect")` 

___________________________________________________________________________________________

# 目录


[TOC]


___________________________________________________________________________________________

<details>
<summary>视频链接</summary>

[10. Constructing the Spell Menu Widget Controller_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1TH4y1L7NP/?p=77&spm_id_from=pageDriver&vd_source=9e1e64122d802b4f7ab37bd325a89e6c)

------

</details>

___________________________________________________________________________________________

### Mermaid整体思路梳理

Mermaid

___________________________________________________________________________________________

### 回顾一下，之前我们的 `WidgetController` 的几个问题

  - 保存在哪里？

  - 如何初始化？

  - 如何广播初始值的？

  - 回忆一下
>![img](https://api2.mubu.com/v3/document_image/25165450_6bb8df91-484e-4c96-bcc3-d46ea6c1190f.png)


<details>
<summary>答案</summary>

>- #### **保存在哪里？**
>
>- #### **如何初始化？**
>
>- #### **如何广播初始值的？**
>
>
>#### **流程梳理：**
>
>- 第一次调用时（在角色中），调用AuraHUD中的获取函数传入参数初始化
>![img](https://api2.mubu.com/v3/document_image/25165450_67c0f962-a649-4ca8-ddd6-dcfbce564f69.png)
>
>- 角色初始化时调用 `AuraHUD` 中的初始化UI的函数，然后给函数传参（四大数据）
>![img](https://api2.mubu.com/v3/document_image/25165450_87b8c579-5fec-4417-de48-bb63e1fa74a3.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_eb7c46d7-4618-4731-9678-090e8a75232b.png)
>
>- 创建 `OverlayWidgetController` 并传入四大数据，创建时，根据ASC中的广播状态选择直接调用初始化或者绑定回调
>![img](https://api2.mubu.com/v3/document_image/25165450_0721d3f4-954c-4698-b999-956f8f4e8485.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_681a8cff-0921-4ba4-dfef-a51a9acd69bf.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_f504e119-dfa3-4eb9-d535-ff412c7a1807.png)
>
>- 别的WidgetController则在 `EventConstruct` 触发时，调用蓝图函数库中获取函数，这时调用AuraHUD中的Get逻辑：创建初始化并绑定回调（与OverlayWidgetController的区别是，Overlay是在代码中调用的）
>![img](https://api2.mubu.com/v3/document_image/25165450_80369bf7-7199-4c3e-857a-1745d20d3faf.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_138e7346-d67c-452c-e10a-927934d1b08b.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_41b242f8-57aa-4891-a56d-d50edffd6c51.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_b88909ac-4247-4c6d-b588-51e1525bd09e.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_686da851-7da2-46e9-9221-3ec1917149d4.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_157603ca-c8b7-4877-b38a-fdf2d0dac57c.png)
>
>- 调用这个函数，就会将所有激活的函数，发送到UI（也就是更新UI中的技能数据）
>![img](https://api2.mubu.com/v3/document_image/25165450_9e553bac-07e7-4e97-8537-a7b6ce02bbde.png)
>
>- 所以总结就是：只要调用了 `BroadcastAbilityInfo` 就会广播所有的技能结构体，接下来只需要处理这个广播和判断状态即可（比如什么技能什么状态才能显示是否锁定这种，当然目前还没制作）

------

</details>



------

### 在 `AuraHUD` 中创建获取 `SpellMenu` 并初始化的函数，和持有指针，初始化时的Class
>![img](https://api2.mubu.com/v3/document_image/25165450_da51f928-aba8-48c2-8426-ba42e4861547.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_8602a991-eb28-40af-c865-5f254fe2b212.png)


------

#### 参考别的写一下初始化
>![img](https://api2.mubu.com/v3/document_image/25165450_0bc8d3ec-953b-47be-9198-d756374ae76e.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_28062da5-21b3-48fb-eacf-792649770b32.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_5c32ce33-611a-4be5-f024-6f752c2db3fa.png)


------

### 我们需要优化蓝图函数库中的逻辑，因为这部分复用率有点高

  - 我们先来看一下，我们使用PC拿到HUD然后获取四大数据，然后分别调用不同函数传递参数并返回 `WidgetController`
    - 可以先搞一个创建Param参数的函数

  - 
>![img](https://api2.mubu.com/v3/document_image/25165450_4c905d26-0f5e-4877-9193-51ce7a9baa8b.png)


------

#### 我们创建一个函数，来创建需要的参数
>![img](https://api2.mubu.com/v3/document_image/25165450_56e4a9e6-fdf2-4bd4-c2d2-90be8034d529.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_6f0d6bf2-9f9f-423b-83e7-bb113d0d98a2.png)


------

#### 但是这样做会有一个问题，假如我们某一步的转换失败，那么我们将得到一个空的参数，后面会用这个空的参数去初始化 `WidgetController` 这有点不太行


------

#### 我们修改创建参数的函数，不要返回Param结构体，改成传进一个Param结构体的引用，这样可以在函数内部修改值，返回值改为bool，这样可以知道成功或者失败。而且这样做有一个好处是：如果返回结构体，则需要在头文件中引用结构体所在的头文件；但如果引用传参，只需前向声明结构体即可，减少项目冗余引用，提高运行效率
>![img](https://api2.mubu.com/v3/document_image/25165450_63656e3e-eab3-440f-8fdf-d83bbb8d1361.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_54da0366-636e-4773-9207-531a795a884f.png)


------

#### 当我们在原来的函数中使用时，还会遇到一个问题：原来的函数中使用了HUD来调用不同的函数，所以需要一个HUD的指针
>![img](https://api2.mubu.com/v3/document_image/25165450_e581e545-a2de-4a0c-f3ef-6c3e84383976.png)

- 如果我们还是 `Cast` 获取，太愚蠢了


------

#### 我们可以在创建参数结构体的函数中，再传递一个HUD的指针引用，来让函数内部赋值，从而在函数外部使用


------

##### 比如像这样
>![img](https://api2.mubu.com/v3/document_image/25165450_3e1a5322-aa5b-4f83-f07f-17f4fbc9a7be.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_ea4345bd-32c3-4a4b-fe29-d4a313325fbc.png)


------

#### 这样就可以正常调用函数逻辑了
>![img](https://api2.mubu.com/v3/document_image/25165450_afb4a2db-248d-4e74-e30e-a68f402b1775.png)


------

#### 接下来重构其他的获取WidgetController的函数
>![img](https://api2.mubu.com/v3/document_image/25165450_8e743ea8-fac0-415a-fc27-e8e3922e89ce.png)


------

### 接下来我们需要创建 `SpellMenuWidgetController` 的蓝图子类所以需要加上 `蓝图可实例化` 和 `蓝图类` 的宏
>![img](https://api2.mubu.com/v3/document_image/25165450_bbb6f4b6-caf2-4e45-81d0-e247d5014b90.png)


------

#### 创建蓝图子类，配置 `升级的数据资产` 
>![img](https://api2.mubu.com/v3/document_image/25165450_7f7b6f77-210c-4d19-c7d7-9e179aa9f172.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_7853abaa-8835-4ee6-8a68-898b3bb2fd44.png)


------

##### 为所有WidgetController都配置上了 `升级的数据资产`
>![img](https://api2.mubu.com/v3/document_image/25165450_f9883ad8-ca11-45a7-cccc-da136eb9f3e1.png)


------

### ***BP_AuraHUD*** 中也需要配置
>![img](https://api2.mubu.com/v3/document_image/25165450_11d978a2-9867-446a-9f03-9463505f689c.png)


------

### 纠正一点！之前的发送广播的逻辑是在 `EventDestruct` 时调用的
>![img](https://api2.mubu.com/v3/document_image/25165450_d886ccd0-f65c-40c9-a85f-9fd3042249a5.png)


------

### 我们也需要在Construct时调用 `SetWidgetController` 
>![img](https://api2.mubu.com/v3/document_image/25165450_d80a6e6a-0d25-443f-a0d9-39e34eeefe70.png)


------

## 有一个小技巧：蓝图可读节点中的参数比如 `WorldContextObject` 能不能像有些函数一样默认值是Self呢？
>![img](https://api2.mubu.com/v3/document_image/25165450_096c6067-457f-47e9-e045-d785e8e9d3e4.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_4cbbba21-835d-497b-fa81-732bfd291463.png)


------

### 需要使用宏 `UFUNCTION(meta = (DefaultToSelf = "WorldContextObiect")` 
>![img](https://api2.mubu.com/v3/document_image/25165450_b1e2aaa4-900e-41b7-dc95-c729d86e99b8.png)


------

### 为获取函数，加上默认Self的宏
>![img](https://api2.mubu.com/v3/document_image/25165450_96aba771-11f4-4f92-cce1-f18c99caa902.png)


------

### 打印测试拿到的 `SpellMenuWidgetController`
>![img](https://api2.mubu.com/v3/document_image/25165450_7626699a-4b8f-4246-885f-ae86d51cac1b.png)
>![img](https://api2.mubu.com/v3/document_image/25165450_dfe9aa0a-a15a-473b-9184-5afb20afb95f.png)


------

### 下一节我们将处理，让 `SpellMenu` 中的装备技能与 `Overlay面板` 中的技能同步
>![img](https://api2.mubu.com/v3/document_image/25165450_7ccee71a-488a-434a-ed3c-ef90e56d6727.png)


___________________________________________________________________________________________

[返回最上面](#Go主菜单)

___________________________________________________________________________________________